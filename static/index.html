<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>企业级文件上传系统</title>
  
  <!-- Tailwind CSS -->
  <script src="/go-uploader/static/js/tailwind-3.4.16.js"></script>
  
  <!-- Alpine.js -->
  <script defer src="/go-uploader/static/js/alpinejs-3.14.9.js"></script>
  
  <!-- Spark MD5 for file hashing -->
  <script src="/go-uploader/static/js/spark-md5.min.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            }
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'bounce-slow': 'bounce 2s infinite',
          }
        }
      }
    }
  </script>
  
  <style>
    .upload-area-hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05));
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .progress-shimmer::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    .card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .notification-enter {
      transform: translateX(100%);
      opacity: 0;
    }
    
    .notification-enter-active {
      transform: translateX(0);
      opacity: 1;
      transition: all 0.3s ease-out;
    }
    
    .notification-leave-active {
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease-in;
    }
  </style>
</head>

<body class="min-h-screen bg-gray-50">
  <div x-data="fileUploadApp()" x-init="init()" class="container mx-auto px-4 py-4 max-w-6xl">
    
    <!-- 系统状态头部 -->
    <div class="card p-4 mb-4">
      <h1 class="text-2xl font-bold text-gray-800 text-center mb-4">
        🚀 文件上传系统
      </h1>
      
      <!-- 系统状态指示器 -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="text-center p-3 rounded-lg bg-blue-50 border border-blue-200">
          <div class="flex items-center justify-center mb-1">
            <div class="w-2 h-2 rounded-full mr-1" 
                 :class="systemHealth === 'healthy' ? 'bg-green-500' : 
                         systemHealth === 'warning' ? 'bg-yellow-500' : 'bg-red-500'"></div>
            <span class="text-gray-700 text-sm font-medium">系统状态</span>
    </div>
          <div class="text-lg font-bold text-gray-800" x-text="systemHealthText"></div>
    </div>
        
        <div class="text-center p-3 rounded-lg bg-green-50 border border-green-200">
          <span class="text-gray-700 text-sm font-medium block mb-1">活跃任务</span>
          <div class="text-lg font-bold text-gray-800" x-text="metrics.activeTasks"></div>
    </div>
        
        <div class="text-center p-3 rounded-lg bg-purple-50 border border-purple-200">
          <span class="text-gray-700 text-sm font-medium block mb-1">内存使用</span>
          <div class="text-lg font-bold text-gray-800" x-text="metrics.memoryUsage + ' MB'"></div>
  </div>
  
        <div class="text-center p-3 rounded-lg bg-orange-50 border border-orange-200">
          <span class="text-gray-700 text-sm font-medium block mb-1">上传速度</span>
          <div class="text-lg font-bold text-gray-800" x-text="formatSpeed(uploadSpeed)"></div>
        </div>
      </div>
  </div>
  
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
      
      <!-- 主上传面板 -->
      <div class="lg:col-span-3 space-y-4">
        
        <!-- 配置面板 -->
        <div class="card p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
            ⚙️ 上传配置
          </h3>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div>
              <label class="block text-gray-700 text-sm font-medium mb-1">分片大小</label>
              <select x-model="config.chunkSize" @change="updateChunkSize()" 
                      class="w-full px-2 py-1 bg-white border border-gray-300 rounded text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="5">5MB</option>
                <option value="10">10MB</option>
                <option value="20">20MB</option>
                <option value="50">50MB</option>
                <option value="100">100MB</option>
              </select>
  </div>
  
            <div>
              <label class="block text-gray-700 text-sm font-medium mb-1">并发数量</label>
              <select x-model="config.concurrent" 
                      class="w-full px-2 py-1 bg-white border border-gray-300 rounded text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
    </div>
            
            <div>
              <label class="block text-gray-700 text-sm font-medium mb-1">MD5校验</label>
              <select x-model="config.enableMD5" 
                      class="w-full px-2 py-1 bg-white border border-gray-300 rounded text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="true">启用</option>
                <option value="false">禁用</option>
              </select>
  </div>
  
            <div>
              <label class="block text-gray-700 text-sm font-medium mb-1">重试次数</label>
              <select x-model="config.retryCount" 
                      class="w-full px-2 py-1 bg-white border border-gray-300 rounded text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="1">1次</option>
                <option value="3">3次</option>
                <option value="5">5次</option>
                <option value="10">10次</option>
              </select>
            </div>
          </div>
        </div>

        <!-- 文件上传区域 -->
        <div class="card p-4">
          <div 
            @drop.prevent="handleDrop($event)"
            @dragover.prevent="dragOver = true"
            @dragleave.prevent="dragOver = false"
            :class="dragOver ? 'upload-area-hover' : ''"
            class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center transition-all duration-300 hover:bg-gray-50">
            
            <div class="text-4xl mb-3" :class="dragOver ? 'animate-bounce-slow' : ''">📁</div>
            <p class="text-gray-700 text-base mb-2">拖拽文件到此处或使用下方按钮选择</p>
            <p class="text-gray-500 text-sm">支持单文件和文件夹上传，自动断点续传</p>
            <p class="text-gray-400 text-xs mt-1">💡 文件夹选择：进入目标文件夹后点击"选择文件夹"按钮</p>
            
            <input type="file" 
                   x-ref="fileInput" 
                   @change="handleFileSelect($event)" 
                   multiple 
                   class="hidden">
            <input type="file" 
                   x-ref="folderInput" 
                   @change="handleFolderSelect($event)" 
                   webkitdirectory 
                   class="hidden">
  </div>
  
          <!-- 操作按钮 -->
          <div class="flex flex-wrap gap-2 mt-4">
            <button @click="selectFiles()" 
                    class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm transition-colors duration-200">
              📄 选择文件
            </button>
            
            <button @click="selectFolder()" 
                    class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded text-sm transition-colors duration-200"
                    title="选择整个文件夹进行上传，包含子文件夹中的所有文件">
              📁 选择文件夹
            </button>
            
            <button @click="startUpload()" 
                    :disabled="files.length === 0 || (isUploading && !isPaused)"
                    class="px-4 py-2 bg-green-500 hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white rounded text-sm transition-colors duration-200">
              <span x-show="!isUploading">🚀 开始上传</span>
              <span x-show="isUploading && isPaused">▶️ 继续上传</span>
            </button>
            
            <button x-show="isUploading && !isPaused" 
                    @click="pauseUpload()" 
                    class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded text-sm transition-colors duration-200">
              ⏸️ 暂停
            </button>
            
            <button x-show="isUploading" 
                    @click="cancelUpload()" 
                    class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition-colors duration-200">
              ❌ 取消
            </button>
          </div>
        </div>

        <!-- 进度显示 -->
        <div x-show="isUploading || progress.total > 0" class="card p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">📊 上传进度</h3>
          
          <div class="mb-3">
            <div class="flex justify-between text-gray-700 mb-2 text-sm">
              <span x-text="`${progress.completed}/${progress.total} (${progress.percentage.toFixed(1)}%)`"></span>
              <span x-text="remainingTime"></span>
            </div>
            
            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
              <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full relative progress-shimmer transition-all duration-300" 
                   :style="`width: ${progress.percentage}%`"></div>
            </div>
          </div>
          
          <!-- 统计信息 -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div class="text-center p-2 bg-blue-50 rounded border border-blue-200">
              <div class="text-lg font-bold text-gray-800" x-text="progress.completed"></div>
              <div class="text-gray-600 text-xs">已完成</div>
            </div>
            <div class="text-center p-2 bg-red-50 rounded border border-red-200">
              <div class="text-lg font-bold text-gray-800" x-text="progress.failed"></div>
              <div class="text-gray-600 text-xs">失败</div>
            </div>
            <div class="text-center p-2 bg-green-50 rounded border border-green-200">
              <div class="text-lg font-bold text-gray-800" x-text="formatFileSize(progress.totalSize)"></div>
              <div class="text-gray-600 text-xs">总大小</div>
            </div>
            <div class="text-center p-2 bg-purple-50 rounded border border-purple-200">
              <div class="text-lg font-bold text-gray-800" x-text="formatFileSize(progress.uploadedSize)"></div>
              <div class="text-gray-600 text-xs">已上传</div>
            </div>
          </div>
        </div>

        <!-- 文件列表 -->
        <div class="card p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">📋 文件列表</h3>
          
          <div x-show="files.length === 0" class="text-center py-8 text-gray-500">
            暂无文件，请选择要上传的文件
          </div>
          
          <div x-show="files.length > 0" class="space-y-2 max-h-64 overflow-y-auto">
            <div class="bg-gray-50 rounded p-2 mb-3 text-sm">
              <span class="text-gray-700 font-medium">
                共 <span x-text="files.length"></span> 个文件，总大小: <span x-text="formatFileSize(totalFileSize)"></span>
              </span>
            </div>
            
            <template x-for="file in files" :key="file.id">
              <div class="bg-gray-50 rounded p-3 flex items-center justify-between">
                <div class="flex-1 min-w-0">
                  <div class="text-gray-800 font-medium truncate text-sm" x-text="file.name"></div>
                  <div class="text-gray-600 text-xs">
                    <span x-text="formatFileSize(file.size)"></span>
                    <span x-show="file.progress > 0" x-text="`(${file.progress}%)`"></span>
                  </div>
                </div>
                
                <div class="ml-3">
                  <span class="px-2 py-1 rounded text-xs font-medium"
                        :class="getStatusClass(file.status)" 
                        x-text="getStatusText(file.status)"></span>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- 操作日志 -->
        <div class="card p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">📝 操作日志</h3>
          
          <div class="bg-gray-100 rounded p-3 max-h-48 overflow-y-auto font-mono text-xs">
            <template x-for="log in logs.slice(-30)" :key="log.id">
              <div class="mb-1">
                <span class="text-gray-500" x-text="log.timestamp"></span>
                <span :class="getLogClass(log.level)" x-text="log.message"></span>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- 侧边栏 -->
      <div class="space-y-4">
        
        <!-- 任务管理 -->
        <div class="card p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">📊 任务管理</h3>
          
          <div class="space-y-2 mb-3">
            <button @click="refreshServerTasks()" 
                    class="w-full px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm transition-colors duration-200">
              🔄 刷新任务
            </button>
            <button @click="cleanupTasks()" 
                    class="w-full px-3 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded text-sm transition-colors duration-200">
              🧹 清理任务
            </button>
          </div>
          
          <div class="space-y-2 max-h-64 overflow-y-auto">
            <div x-show="serverTasks.length === 0" class="text-center py-6 text-gray-500 text-sm">
              点击刷新加载服务器任务
            </div>
            
            <template x-for="task in serverTasks" :key="task.file_id">
              <div class="bg-gray-50 rounded p-2">
                <div class="flex justify-between items-start mb-1">
                  <div class="flex-1 min-w-0">
                    <div class="text-gray-800 font-medium text-xs truncate" x-text="task.filename"></div>
                    <div class="text-gray-600 text-xs" x-text="formatFileSize(task.file_size)"></div>
                  </div>
                  <div class="ml-2">
                    <span class="px-1 py-0.5 rounded text-xs"
                          :class="getStatusClass(task.status)" 
                          x-text="getStatusText(task.status)"></span>
                  </div>
                </div>
                
                <!-- 进度条 -->
                <div class="w-full bg-gray-200 rounded-full h-1 mb-1">
                  <div class="h-full bg-blue-400 rounded-full" 
                       :style="`width: ${task.completion_rate || 0}%`"></div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="flex gap-1">
                  <button x-show="task.status === 'paused' || task.status === 'failed'" 
                          @click="resumeTask(task.file_id)"
                          class="text-xs px-1 py-0.5 bg-green-500 hover:bg-green-600 text-white rounded">
                    恢复
                  </button>
                  <button x-show="task.status === 'uploading'" 
                          @click="pauseTask(task.file_id)"
                          class="text-xs px-1 py-0.5 bg-yellow-500 hover:bg-yellow-600 text-white rounded">
                    暂停
                  </button>
                  <button @click="deleteTask(task.file_id)"
                          class="text-xs px-1 py-0.5 bg-red-500 hover:bg-red-600 text-white rounded">
                    删除
                  </button>
                  <button @click="showTaskDetail(task)"
                          class="text-xs px-1 py-0.5 bg-blue-500 hover:bg-blue-600 text-white rounded">
                    详情
                  </button>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- 系统监控 -->
        <div class="card p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">📈 系统监控</h3>
          
          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="text-center p-2 bg-blue-50 rounded border border-blue-200">
              <div class="text-lg font-bold text-gray-800" x-text="taskStats.total"></div>
              <div class="text-gray-600 text-xs">总任务</div>
            </div>
            <div class="text-center p-2 bg-green-50 rounded border border-green-200">
              <div class="text-lg font-bold text-gray-800" x-text="taskStats.successRate + '%'"></div>
              <div class="text-gray-600 text-xs">成功率</div>
            </div>
            <div class="text-center p-2 bg-purple-50 rounded border border-purple-200">
              <div class="text-lg font-bold text-gray-800" x-text="systemInfo.diskUsage + '%'"></div>
              <div class="text-gray-600 text-xs">磁盘使用</div>
            </div>
            <div class="text-center p-2 bg-orange-50 rounded border border-orange-200">
              <div class="text-lg font-bold text-gray-800" x-text="metrics.goroutines"></div>
              <div class="text-gray-600 text-xs">协程数</div>
            </div>
          </div>
          
          <button @click="showSystemInfo()" 
                  class="w-full px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded text-sm transition-colors duration-200">
            🖥️ 详细信息
          </button>
        </div>
      </div>
    </div>

    <!-- 通知容器 -->
    <div class="fixed top-4 right-4 z-50 space-y-2">
      <template x-for="notification in notifications" :key="notification.id">
        <div x-show="notification.show"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="transform translate-x-full opacity-0"
             x-transition:enter-end="transform translate-x-0 opacity-100"
             x-transition:leave="transition ease-in duration-300"
             x-transition:leave-start="transform translate-x-0 opacity-100"
             x-transition:leave-end="transform translate-x-full opacity-0"
             class="px-6 py-4 rounded-lg shadow-lg max-w-sm"
             :class="getNotificationClass(notification.type)">
          <div class="flex items-center">
            <span x-text="getNotificationIcon(notification.type)" class="mr-2"></span>
            <span x-text="notification.message" class="flex-1"></span>
          </div>
        </div>
      </template>
    </div>

    <!-- 模态框 -->
    <div x-show="showModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto"
         style="display: none;">
      
      <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" @click="closeModal()"></div>
        
        <div class="inline-block w-full max-w-2xl p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-white rounded-lg shadow-xl">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-800" x-text="modalTitle"></h3>
            <button @click="closeModal()" class="text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <div class="text-gray-800" x-html="modalContent"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function fileUploadApp() {
      return {
        // 基础状态
        dragOver: false,
        isUploading: false,
        isPaused: false,
        cancelFlag: false,
        
        // 配置
        config: {
          chunkSize: 10,
          concurrent: 3,
          enableMD5: 'true',
          retryCount: 3
        },
        
        // 文件和任务
        files: [],
        serverTasks: [],
        
        // 进度和统计
        progress: {
          completed: 0,
          failed: 0,
          total: 0,
          percentage: 0,
          totalSize: 0,
          uploadedSize: 0
        },
        
        // 系统监控
        systemHealth: 'checking',
        metrics: {
          activeTasks: 0,
          memoryUsage: 0,
          goroutines: 0
        },
        taskStats: {
          total: 0,
          successRate: 0
        },
        systemInfo: {
          diskUsage: 0
        },
        
        // UI状态
        logs: [],
        notifications: [],
        showModal: false,
        modalTitle: '',
        modalContent: '',
        
        // 性能监控
        uploadSpeed: 0,
        lastUploadedBytes: 0,
        lastSpeedUpdate: Date.now(),
        startTime: 0,
        
        // 初始化
        init() {
          this.log('系统初始化中...', 'info');
          this.checkSystemHealth();
          this.refreshServerTasks();
          this.updateSystemStatus();
          
          // 定时任务
          setInterval(() => this.updateSystemStatus(), 5000);
          setInterval(() => this.checkSystemHealth(), 30000);
          setInterval(() => this.updateUploadSpeed(), 1000);
        },
        
        // 文件处理
        selectFiles() {
          this.$refs.fileInput.click();
        },
        
        selectFolder() {
          this.showNotification('💡 提示：在文件选择对话框中，请点击进入要上传的文件夹，然后点击对话框右下角的"选择文件夹"或"Upload"按钮', 'info');
          this.$refs.folderInput.click();
        },
        
        handleFileSelect(event) {
          const files = Array.from(event.target.files);
          this.addFilesToQueue(files);
          // 清空输入框以允许重复选择相同文件
          event.target.value = '';
        },
        
        handleFolderSelect(event) {
          const files = Array.from(event.target.files);
          if (files.length > 0) {
            // 分析文件夹结构
            const folderName = files[0].webkitRelativePath.split('/')[0];
            const fileExtensions = [...new Set(files.map(f => f.name.split('.').pop().toLowerCase()))];
            const totalSize = files.reduce((sum, f) => sum + f.size, 0);
            
            this.log(`✅ 成功选择文件夹 "${folderName}"，包含 ${files.length} 个文件 (${this.formatFileSize(totalSize)})`, 'success');
            this.showNotification(`📁 已选择文件夹 "${folderName}"，包含 ${files.length} 个文件`, 'success');
            
            if (fileExtensions.length > 1) {
              this.log(`📄 文件类型包括: ${fileExtensions.slice(0, 5).join(', ')}${fileExtensions.length > 5 ? ' 等' : ''}`, 'info');
            }
            
            this.addFilesToQueue(files);
          } else {
            this.showNotification('⚠️ 未选择任何文件，请重试', 'warning');
          }
          
          // 清空输入框以允许重复选择相同文件夹
          event.target.value = '';
        },
        
        handleDrop(event) {
          this.dragOver = false;
          const files = Array.from(event.dataTransfer.files);
          this.addFilesToQueue(files);
        },
        
        addFilesToQueue(files) {
          for (const file of files) {
            this.files.push({
              id: this.generateFileId(file),
              file: file,
              name: file.webkitRelativePath || file.name,
              size: file.size,
              status: 'pending',
              progress: 0,
              uploadedBytes: 0
            });
          }
          
          this.updateProgress();
          this.log(`添加了 ${files.length} 个文件到上传队列`, 'info');
          this.showNotification(`已添加 ${files.length} 个文件`, 'success');
        },
        
        generateFileId(file) {
          const relativePath = file.webkitRelativePath || file.name;
          return `${relativePath}-${file.size}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        },
        
        // 上传控制
        async startUpload() {
          if (this.files.length === 0) {
            this.showNotification('请先选择要上传的文件', 'warning');
            return;
          }
          
          this.isUploading = true;
          this.isPaused = false;
          this.cancelFlag = false;
          this.startTime = Date.now();
          this.lastUploadedBytes = 0;
          this.lastSpeedUpdate = Date.now();
          
          this.log(`开始上传，共 ${this.files.length} 个文件`, 'info');
          
          try {
            await this.concurrentUpload();
            this.log(`上传完成: ${this.progress.completed}/${this.files.length} 个文件成功`, 'success');
            this.showNotification('所有文件上传完成！', 'success');
          } catch (error) {
            this.log(`上传出错: ${error.message}`, 'error');
            this.showNotification('上传过程中出现错误', 'error');
          } finally {
            this.isUploading = false;
            this.refreshServerTasks();
          }
        },
        
        pauseUpload() {
          this.isPaused = true;
          this.log('上传已暂停', 'warning');
          this.showNotification('上传已暂停', 'info');
        },
        
        cancelUpload() {
          if (confirm('确定要取消所有上传任务吗？')) {
            this.cancelFlag = true;
            this.isPaused = false;
            this.isUploading = false;
            this.log('用户取消上传', 'warning');
            this.showNotification('上传已取消', 'warning');
          }
        },
        
        // 并发上传
        async concurrentUpload() {
          const pendingFiles = this.files.filter(f => f.status === 'pending' || f.status === 'error');
      let index = 0;
      const workers = [];
      
          // 定义上传工作函数
          const uploadWorker = async () => {
            while (index < pendingFiles.length && !this.cancelFlag && !this.isPaused) {
          const fileIndex = index++;
              const fileItem = pendingFiles[fileIndex];
              
              if (!fileItem || (fileItem.status !== 'pending' && fileItem.status !== 'error')) continue;
              
              fileItem.status = 'uploading';
              this.updateProgress();
              
              try {
                await this.uploadSingleFile(fileItem);
                fileItem.status = 'completed';
                fileItem.progress = 100;
                this.progress.completed++;
                this.log(`✅ 完成: ${fileItem.name}`, 'success');
          } catch (error) {
                fileItem.status = 'error';
                this.progress.failed++;
                this.log(`❌ 失败: ${fileItem.name} - ${error.message}`, 'error');
              }
              
              this.updateProgress();
            }
          };
          
          // 创建多个工作线程
          for (let i = 0; i < this.config.concurrent; i++) {
            workers.push(uploadWorker());
      }
      
      // 等待所有工作线程完成
      await Promise.all(workers);
        },
        
        // 单文件上传
        async uploadSingleFile(fileItem) {
          const file = fileItem.file;
          const fileId = fileItem.id;
          const chunkSize = this.config.chunkSize * 1024 * 1024;
          const totalChunks = Math.ceil(file.size / chunkSize);
          
          // 检查服务器上的上传状态
      let uploadedChunks = [];
      try {
            const response = await this.fetchWithRetry(`/go-uploader/upload_status?file_id=${encodeURIComponent(fileId)}`);
            const data = await response.json();
        uploadedChunks = data.uploaded_chunks || [];
          } catch (error) {
            this.log(`获取上传状态失败: ${error.message}`, 'warning');
      }

      // 上传分片
      for (let i = 0; i < totalChunks; i++) {
            if (this.cancelFlag || this.isPaused) {
              throw new Error('上传被中断');
            }
        
        if (uploadedChunks.includes(i)) {
              continue; // 跳过已上传的分片
        }

            const start = i * chunkSize;
            const end = Math.min(file.size, start + chunkSize);
        const chunk = file.slice(start, end);

            await this.uploadChunk(fileId, i, chunk, file, fileItem);
            
            // 更新进度
            fileItem.progress = Math.round(((i + 1) / totalChunks) * 100);
            fileItem.uploadedBytes = (i + 1) * chunkSize;
            this.lastUploadedBytes += chunk.size;
          }
          
          // 合并文件
          await this.mergeFile(fileId, file, totalChunks);
        },
        
        // 上传分片
        async uploadChunk(fileId, chunkIndex, chunk, file, fileItem) {
          const formData = new FormData();
          formData.append('file_id', fileId);
          formData.append('chunk_index', chunkIndex);
          formData.append('chunk', chunk);
          formData.append('relative_path', file.webkitRelativePath || file.name);
          formData.append('total_chunks', Math.ceil(file.size / (this.config.chunkSize * 1024 * 1024)));
          formData.append('file_size', file.size);
          
          if (this.config.enableMD5 === 'true') {
            const md5 = await this.calculateMD5(chunk);
            formData.append('md5', md5);
          }
          
          const response = await this.fetchWithRetry('/go-uploader/upload_chunk', {
            method: 'POST',
            body: formData
          });
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `上传分片 ${chunkIndex} 失败: ${response.status}`);
          }
        },

      // 合并文件
        async mergeFile(fileId, file, totalChunks) {
          const formData = new FormData();
          formData.append('file_id', fileId);
          formData.append('filename', file.name);
          formData.append('total_chunks', totalChunks);
          formData.append('relative_path', file.webkitRelativePath || file.name);
          
          const response = await this.fetchWithRetry('/go-uploader/merge_chunks', {
            method: 'POST',
            body: formData
          });
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `合并文件失败: ${response.status}`);
          }
          
          const result = await response.json();
          this.log(`文件合并成功: ${result.filePath}`, 'success');
      return result;
        },
        
        // MD5计算 - 修复版本
        async calculateMD5(file) {
          return new Promise((resolve, reject) => {
            const spark = new SparkMD5.ArrayBuffer();
            const fileReader = new FileReader();
            
            fileReader.onload = function(e) {
              spark.append(e.target.result);
              resolve(spark.end());
            };
            
            fileReader.onerror = function() {
              reject(new Error('文件读取失败'));
            };
            
            fileReader.readAsArrayBuffer(file);
          });
        },
        
        // 网络请求重试
        async fetchWithRetry(url, options = {}, attempts = undefined) {
          const maxAttempts = attempts || this.config.retryCount;
          
          for (let i = 0; i < maxAttempts; i++) {
            try {
              const response = await fetch(url, options);
              if (response.ok) {
                return response;
              }
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            } catch (error) {
              if (i === maxAttempts - 1) {
                throw error;
              }
              
              const delay = Math.min(1000 * Math.pow(2, i), 10000);
              this.log(`请求失败，${delay}ms 后重试 (${i + 1}/${maxAttempts}): ${error.message}`, 'warning');
              await this.sleep(delay);
            }
          }
        },
        
        // 任务管理
        async refreshServerTasks() {
          try {
            const response = await fetch('/go-uploader/tasks');
            const data = await response.json();
            this.serverTasks = data.tasks || [];
            this.updateTaskStats();
          } catch (error) {
            this.log(`获取服务器任务失败: ${error.message}`, 'error');
          }
        },
        
        async pauseTask(fileId) {
          try {
            const response = await fetch(`/go-uploader/tasks/${fileId}/pause`, { method: 'POST' });
            if (response.ok) {
              this.showNotification('任务已暂停', 'success');
              this.refreshServerTasks();
            } else {
              const error = await response.json();
              this.showNotification(error.error || '暂停任务失败', 'error');
            }
          } catch (error) {
            this.showNotification('暂停任务失败', 'error');
          }
        },
        
        async resumeTask(fileId) {
          try {
            const response = await fetch(`/go-uploader/tasks/${fileId}/resume`, { method: 'POST' });
            if (response.ok) {
              this.showNotification('任务已恢复', 'success');
              this.refreshServerTasks();
            } else {
              const error = await response.json();
              this.showNotification(error.error || '恢复任务失败', 'error');
            }
          } catch (error) {
            this.showNotification('恢复任务失败', 'error');
          }
        },
        
        async deleteTask(fileId) {
          if (!confirm('确定要删除这个任务吗？')) return;
          
          try {
            const response = await fetch(`/go-uploader/tasks/${fileId}`, { method: 'DELETE' });
            if (response.ok) {
              this.showNotification('任务已删除', 'success');
              this.refreshServerTasks();
            } else {
              const error = await response.json();
              this.showNotification(error.error || '删除任务失败', 'error');
            }
          } catch (error) {
            this.showNotification('删除任务失败', 'error');
          }
        },
        
        async cleanupTasks() {
          if (!confirm('确定要清理所有已完成和失败的任务吗？')) return;
          
          try {
            const response = await fetch('/go-uploader/tasks/cleanup', { method: 'POST' });
            if (response.ok) {
              const result = await response.json();
              this.showNotification(result.message, 'success');
              this.refreshServerTasks();
            } else {
              const error = await response.json();
              this.showNotification(error.error || '清理任务失败', 'error');
            }
          } catch (error) {
            this.showNotification('清理任务失败', 'error');
          }
        },
        
        // 系统监控
        async checkSystemHealth() {
          try {
            const response = await fetch('/go-uploader/health');
            const health = await response.json();
            this.systemHealth = health.status;
          } catch (error) {
            this.systemHealth = 'unhealthy';
          }
        },
        
        async updateSystemStatus() {
          try {
            const [metricsResponse, systemResponse] = await Promise.all([
              fetch('/go-uploader/metrics'),
              fetch('/go-uploader/system')
            ]);
            
            if (metricsResponse.ok) {
              const metrics = await metricsResponse.json();
              this.metrics = {
                activeTasks: metrics.metrics.active_tasks || 0,
                memoryUsage: metrics.metrics.memory_mb || 0,
                goroutines: metrics.metrics.goroutines || 0
              };
            }
            
            if (systemResponse.ok) {
              const systemData = await systemResponse.json();
              if (systemData.disk_usage && systemData.disk_usage.usage_percent) {
                this.systemInfo.diskUsage = systemData.disk_usage.usage_percent.toFixed(1);
              }
            }
          } catch (error) {
            // 静默处理监控数据获取失败
          }
        },
        
        updateUploadSpeed() {
          if (!this.isUploading || this.isPaused) {
            this.uploadSpeed = 0;
            return;
          }
          
          const now = Date.now();
          const timeDiff = (now - this.lastSpeedUpdate) / 1000;
          
          if (timeDiff >= 1) {
            const bytesDiff = this.lastUploadedBytes;
            this.uploadSpeed = bytesDiff / timeDiff;
            this.lastUploadedBytes = 0;
            this.lastSpeedUpdate = now;
          }
        },
        
        // 详情和模态框
        async showTaskDetail(task) {
          try {
            const response = await fetch(`/go-uploader/tasks/${task.file_id}`);
            const taskDetail = await response.json();
            
            this.modalTitle = '📋 任务详情';
            this.modalContent = `
              <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                  <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <div class="text-lg font-bold text-gray-800">${taskDetail.filename}</div>
                    <div class="text-sm text-gray-600">文件名</div>
                  </div>
                  <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <div class="text-lg font-bold text-gray-800">${this.formatFileSize(taskDetail.file_size)}</div>
                    <div class="text-sm text-gray-600">文件大小</div>
                  </div>
                  <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <div class="text-lg font-bold text-gray-800">${(taskDetail.completion_rate || 0).toFixed(1)}%</div>
                    <div class="text-sm text-gray-600">完成度</div>
                  </div>
                  <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <div class="text-lg font-bold text-gray-800">${this.getStatusText(taskDetail.status)}</div>
                    <div class="text-sm text-gray-600">状态</div>
                  </div>
                </div>
                <div class="space-y-2 text-sm text-gray-700">
                  <p><strong>文件ID:</strong> ${taskDetail.file_id}</p>
                  <p><strong>相对路径:</strong> ${taskDetail.relative_path || '无'}</p>
                  <p><strong>总分片数:</strong> ${taskDetail.total_chunks}</p>
                  <p><strong>已上传分片:</strong> ${taskDetail.uploaded_chunks?.length || 0}</p>
                  <p><strong>创建时间:</strong> ${new Date(taskDetail.created_at).toLocaleString()}</p>
                  <p><strong>更新时间:</strong> ${new Date(taskDetail.updated_at).toLocaleString()}</p>
                  <p><strong>重试次数:</strong> ${taskDetail.retry_count || 0}</p>
                  ${taskDetail.file_md5 ? `<p><strong>文件MD5:</strong> ${taskDetail.file_md5}</p>` : ''}
                </div>
              </div>
            `;
            this.showModal = true;
          } catch (error) {
            this.showNotification('获取任务详情失败', 'error');
          }
        },
        
        async showSystemInfo() {
          try {
            const response = await fetch('/go-uploader/system');
            const data = await response.json();
            
            this.modalTitle = '🖥️ 系统信息';
            this.modalContent = `
              <div class="space-y-6">
                <div>
                  <h4 class="text-lg font-semibold mb-3 text-gray-800">🖥️ 系统信息</h4>
                  <div class="space-y-2 text-sm text-gray-700">
                    <p><strong>Go版本:</strong> ${data.system.go_version}</p>
                    <p><strong>协程数:</strong> ${data.system.goroutines}</p>
                    <p><strong>内存分配:</strong> ${data.system.memory_alloc} MB</p>
                    <p><strong>系统内存:</strong> ${data.system.memory_sys} MB</p>
                    <p><strong>GC运行次数:</strong> ${data.system.gc_runs}</p>
                  </div>
                </div>
                
                <div>
                  <h4 class="text-lg font-semibold mb-3 text-gray-800">⚙️ 配置信息</h4>
                  <div class="space-y-2 text-sm text-gray-700">
                    <p><strong>上传目录:</strong> ${data.config.upload_dir}</p>
                    <p><strong>合并目录:</strong> ${data.config.merged_dir}</p>
                    <p><strong>最大文件大小:</strong> ${this.formatFileSize(data.config.max_file_size)}</p>
                    <p><strong>最大分片大小:</strong> ${this.formatFileSize(data.config.max_chunk_size)}</p>
                    <p><strong>并发上传数:</strong> ${data.config.concurrent_uploads}</p>
                    <p><strong>完整性检查:</strong> ${data.config.enable_integrity_check ? '启用' : '禁用'}</p>
                    <p><strong>原子操作:</strong> ${data.config.enable_atomic_operations ? '启用' : '禁用'}</p>
                  </div>
                </div>
                
                <div>
                  <h4 class="text-lg font-semibold mb-3 text-gray-800">📊 磁盘使用</h4>
                  <div class="space-y-2 text-sm text-gray-700">
                    <p><strong>上传目录大小:</strong> ${this.formatFileSize(data.disk_usage.upload_dir_size || 0)}</p>
                    <p><strong>合并目录大小:</strong> ${this.formatFileSize(data.disk_usage.merged_dir_size || 0)}</p>
                    <p><strong>总使用量:</strong> ${this.formatFileSize(data.disk_usage.total_used || 0)}</p>
                    <p><strong>使用率:</strong> ${(data.disk_usage.usage_percent || 0).toFixed(2)}%</p>
                  </div>
                </div>
              </div>
            `;
            this.showModal = true;
          } catch (error) {
            this.showNotification('获取系统信息失败', 'error');
          }
        },
        
        closeModal() {
          this.showModal = false;
        },
        
        // 更新和计算
        updateChunkSize() {
          this.log(`分片大小调整为: ${this.config.chunkSize}MB`, 'info');
        },
        
        updateProgress() {
          this.progress.total = this.files.length;
          this.progress.completed = this.files.filter(f => f.status === 'completed').length;
          this.progress.failed = this.files.filter(f => f.status === 'error').length;
          this.progress.percentage = this.progress.total > 0 ? (this.progress.completed / this.progress.total) * 100 : 0;
          
          this.progress.totalSize = this.files.reduce((sum, f) => sum + f.size, 0);
          this.progress.uploadedSize = this.files
            .filter(f => f.status === 'completed')
            .reduce((sum, f) => sum + f.size, 0);
        },
        
        updateTaskStats() {
          this.taskStats.total = this.serverTasks.length;
          const completed = this.serverTasks.filter(t => t.status === 'completed').length;
          this.taskStats.successRate = this.taskStats.total > 0 ? ((completed / this.taskStats.total) * 100).toFixed(1) : 0;
        },
        
        // UI辅助方法
        showNotification(message, type = 'info') {
          const id = Date.now() + Math.random();
          const notification = { id, message, type, show: false };
          
          this.notifications.push(notification);
          
          setTimeout(() => {
            notification.show = true;
          }, 100);
          
          setTimeout(() => {
            notification.show = false;
            setTimeout(() => {
              this.notifications = this.notifications.filter(n => n.id !== id);
            }, 300);
          }, 4000);
        },
        
        log(message, level = 'info') {
          const timestamp = new Date().toLocaleTimeString();
          this.logs.push({
            id: Date.now() + Math.random(),
            timestamp: `[${timestamp}]`,
            message: message,
            level: level
          });
          
          // 限制日志数量
          if (this.logs.length > 100) {
            this.logs = this.logs.slice(-100);
          }
        },
        
        // 样式类辅助方法
        getStatusClass(status) {
          const classes = {
            'pending': 'bg-yellow-100 text-yellow-800',
            'uploading': 'bg-blue-100 text-blue-800',
            'completed': 'bg-green-100 text-green-800',
            'error': 'bg-red-100 text-red-800',
            'failed': 'bg-red-100 text-red-800',
            'paused': 'bg-gray-100 text-gray-800'
          };
          return classes[status] || 'bg-gray-100 text-gray-800';
        },
        
        getStatusText(status) {
          const texts = {
            'pending': '等待',
            'uploading': '上传中',
            'completed': '完成',
            'error': '失败',
            'failed': '失败',
            'paused': '暂停'
          };
          return texts[status] || '未知';
        },
        
        getLogClass(level) {
          const classes = {
            'info': 'text-blue-600',
            'success': 'text-green-600',
            'warning': 'text-yellow-600',
            'error': 'text-red-600'
          };
          return classes[level] || 'text-gray-800';
        },
        
        getNotificationClass(type) {
          const classes = {
            'success': 'bg-green-500 text-white',
            'error': 'bg-red-500 text-white',
            'warning': 'bg-yellow-500 text-black',
            'info': 'bg-blue-500 text-white'
          };
          return classes[type] || 'bg-blue-500 text-white';
        },
        
        getNotificationIcon(type) {
          const icons = {
            'success': '✅',
            'error': '❌',
            'warning': '⚠️',
            'info': 'ℹ️'
          };
          return icons[type] || 'ℹ️';
        },
        
        // 计算属性
        get systemHealthText() {
          const texts = {
            'healthy': '正常',
            'warning': '警告',
            'unhealthy': '异常',
            'checking': '检查中'
          };
          return texts[this.systemHealth] || '未知';
        },
        
        get totalFileSize() {
          return this.files.reduce((sum, f) => sum + f.size, 0);
        },
        
        get remainingTime() {
          if (this.progress.completed > 0 && this.startTime > 0) {
            const elapsed = (Date.now() - this.startTime) / 1000;
            const rate = this.progress.completed / elapsed;
            const remaining = (this.progress.total - this.progress.completed) / rate;
            return this.formatTime(remaining);
          }
          return '--:--:--';
        },
        
        // 工具方法
        formatFileSize(bytes) {
          if (bytes === 0) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        
        formatSpeed(bytesPerSecond) {
          if (bytesPerSecond === 0) return '0 MB/s';
          const mbps = bytesPerSecond / (1024 * 1024);
          return mbps.toFixed(2) + ' MB/s';
        },
        
        formatTime(seconds) {
          if (!seconds || seconds === Infinity || isNaN(seconds)) return '--:--:--';
          const hours = Math.floor(seconds / 3600);
          const minutes = Math.floor((seconds % 3600) / 60);
          const secs = Math.floor(seconds % 60);
          return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        },
        
        sleep(ms) {
          return new Promise(resolve => setTimeout(resolve, ms));
        }
      };
    }
  </script>
</body>
</html>
