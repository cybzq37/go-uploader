<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¼ä¸šçº§æ–‡ä»¶ä¸Šä¼ ç³»ç»Ÿ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft YaHei', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .header h1 {
      color: #667eea;
      font-size: 2.5em;
      text-align: center;
      margin-bottom: 10px;
    }
    
    .system-status {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }
    
    .status-item {
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      background: rgba(102, 126, 234, 0.1);
    }
    
    .status-value {
      font-size: 1.5em;
      font-weight: bold;
      color: #667eea;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
    }
    
    .upload-panel {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .card h3 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.2em;
    }
    
    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      margin-bottom: 5px;
      font-weight: 500;
      color: #555;
    }
    
    .form-group select,
    .form-group input {
      padding: 8px 12px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      margin: 20px 0;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .upload-area:hover {
      background: rgba(102, 126, 234, 0.05);
      border-color: #764ba2;
    }
    
    .upload-area.dragover {
      background: rgba(102, 126, 234, 0.1);
      border-color: #667eea;
      transform: scale(1.02);
    }
    
    .upload-icon {
      font-size: 3em;
      color: #667eea;
      margin-bottom: 15px;
    }
    
    .file-input {
      display: none;
    }
    
    .progress-section {
      margin: 20px 0;
    }
    
    .progress-bar {
      width: 100%;
      height: 25px;
      background: #f0f0f0;
      border-radius: 12px;
      overflow: hidden;
      margin: 10px 0;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      border-radius: 12px;
      position: relative;
      overflow: hidden;
    }
    
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
      );
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .progress-text {
      text-align: center;
      margin: 10px 0;
      font-weight: 500;
    }
    
    .file-list {
      max-height: 300px;
      overflow-y: auto;
      margin: 15px 0;
      border-radius: 8px;
      border: 1px solid #e1e8ed;
    }
    
    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.3s;
    }
    
    .file-item:hover {
      background: rgba(102, 126, 234, 0.05);
    }
    
    .file-item:last-child {
      border-bottom: none;
    }
    
    .file-info {
      flex: 1;
      min-width: 0;
    }
    
    .file-name {
      font-weight: 500;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .file-size {
      font-size: 0.9em;
      color: #666;
    }
    
    .file-status {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.85em;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .status-pending { background: #fff3cd; color: #856404; }
    .status-uploading { background: #d1ecf1; color: #0c5460; }
    .status-completed { background: #d4edda; color: #155724; }
    .status-error { background: #f8d7da; color: #721c24; }
    .status-paused { background: #e2e3e5; color: #383d41; }
    
    .button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .button-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .button-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .button-secondary {
      background: #6c757d;
      color: white;
    }
    
    .button-success {
      background: #28a745;
      color: white;
    }
    
    .button-danger {
      background: #dc3545;
      color: white;
    }
    
    .button-warning {
      background: #ffc107;
      color: #212529;
    }
    
    .button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }
    
    .task-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .task-item {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid #e9ecef;
    }
    
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .task-name {
      font-weight: 500;
      color: #495057;
    }
    
    .task-actions {
      display: flex;
      gap: 5px;
    }
    
    .task-actions .button {
      padding: 4px 8px;
      font-size: 12px;
    }
    
    .task-progress {
      height: 6px;
      background: #e9ecef;
      border-radius: 3px;
      overflow: hidden;
      margin: 8px 0;
    }
    
    .task-progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
    }
    
    .task-info {
      font-size: 0.85em;
      color: #6c757d;
      display: flex;
      justify-content: space-between;
    }
    
    .log-container {
      background: #1e1e1e;
      color: #ffffff;
      border-radius: 8px;
      padding: 15px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.85em;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
    }
    
    .log-entry {
      margin-bottom: 3px;
      word-wrap: break-word;
    }
    
    .log-timestamp {
      color: #666;
    }
    
    .log-success { color: #4CAF50; }
    .log-error { color: #f44336; }
    .log-warning { color: #ff9800; }
    .log-info { color: #2196F3; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }
    
    .stat-item {
      text-align: center;
      padding: 10px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 8px;
    }
    
    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
      color: #667eea;
    }
    
    .stat-label {
      font-size: 0.85em;
      color: #666;
      margin-top: 5px;
    }
    
    .health-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .health-healthy { background: #28a745; }
    .health-warning { background: #ffc107; }
    .health-unhealthy { background: #dc3545; }
    
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.85em;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification-success { background: #28a745; }
    .notification-error { background: #dc3545; }
    .notification-warning { background: #ffc107; color: #212529; }
    .notification-info { background: #17a2b8; }
    
    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .config-grid {
        grid-template-columns: 1fr;
      }
      
      .header h1 {
        font-size: 2em;
      }
      
      .system-status {
        flex-direction: column;
        gap: 10px;
      }
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
    }
    
    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 15px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: modalShow 0.3s ease-out;
    }
    
    @keyframes modalShow {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover {
      color: #000;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ç³»ç»ŸçŠ¶æ€å¤´éƒ¨ -->
    <div class="header">
      <h1>ğŸš€ ä¼ä¸šçº§æ–‡ä»¶ä¸Šä¼ ç³»ç»Ÿ</h1>
      <div class="system-status">
        <div class="status-item">
          <div class="health-indicator health-healthy" id="healthIndicator"></div>
          <span>ç³»ç»ŸçŠ¶æ€</span>
          <div class="status-value" id="systemStatus">æ£€æŸ¥ä¸­...</div>
        </div>
        <div class="status-item">
          <span>æ´»è·ƒä»»åŠ¡</span>
          <div class="status-value" id="activeTasks">0</div>
        </div>
        <div class="status-item">
          <span>å†…å­˜ä½¿ç”¨</span>
          <div class="status-value" id="memoryUsage">0 MB</div>
        </div>
        <div class="status-item">
          <span>ä¸Šä¼ é€Ÿåº¦</span>
          <div class="status-value" id="uploadSpeed">0 MB/s</div>
        </div>
      </div>
    </div>

    <div class="main-content">
      <!-- ä¸»ä¸Šä¼ é¢æ¿ -->
      <div class="upload-panel">
        <!-- é…ç½®åŒºåŸŸ -->
        <div class="card">
          <h3>âš™ï¸ ä¸Šä¼ é…ç½®</h3>
          <div class="config-grid">
            <div class="form-group">
              <label>åˆ†ç‰‡å¤§å°</label>
              <select id="chunkSizeSelect">
                <option value="5">5MB (ç½‘ç»œè¾ƒæ…¢)</option>
                <option value="10" selected>10MB (é»˜è®¤)</option>
                <option value="20">20MB (ç½‘ç»œè‰¯å¥½)</option>
                <option value="50">50MB (é«˜é€Ÿç½‘ç»œ)</option>
                <option value="100">100MB (åƒå…†ç½‘ç»œ)</option>
              </select>
            </div>
            <div class="form-group">
              <label>å¹¶å‘æ•°é‡</label>
              <select id="concurrentSelect">
                <option value="1">1 (å•çº¿ç¨‹)</option>
                <option value="2">2 (æ¨è)</option>
                <option value="3" selected>3 (é»˜è®¤)</option>
                <option value="4">4 (é«˜æ€§èƒ½)</option>
                <option value="5">5 (æœ€å¤§)</option>
              </select>
            </div>
            <div class="form-group">
              <label>å¯ç”¨MD5æ ¡éªŒ</label>
              <select id="enableMD5">
                <option value="true" selected>å¯ç”¨</option>
                <option value="false">ç¦ç”¨</option>
              </select>
            </div>
            <div class="form-group">
              <label>é‡è¯•æ¬¡æ•°</label>
              <select id="retryCount">
                <option value="1">1æ¬¡</option>
                <option value="3" selected>3æ¬¡</option>
                <option value="5">5æ¬¡</option>
                <option value="10">10æ¬¡</option>
              </select>
            </div>
          </div>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">ğŸ“</div>
          <p>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
          <p style="color: #666; font-size: 0.9em;">æ”¯æŒå•æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ä¸Šä¼ ï¼Œè‡ªåŠ¨æ–­ç‚¹ç»­ä¼ </p>
          <input type="file" id="fileInput" class="file-input" multiple>
          <input type="file" id="folderInput" class="file-input" webkitdirectory>
        </div>

        <div class="button-group">
          <label class="button button-secondary" for="fileInput">é€‰æ‹©æ–‡ä»¶</label>
          <label class="button button-secondary" for="folderInput">é€‰æ‹©æ–‡ä»¶å¤¹</label>
          <button class="button button-primary" id="uploadBtn" onclick="startUpload()">å¼€å§‹ä¸Šä¼ </button>
          <button class="button button-warning" id="pauseBtn" onclick="pauseUpload()" style="display: none;">æš‚åœ</button>
          <button class="button button-danger" id="cancelBtn" onclick="cancelUpload()" style="display: none;">å–æ¶ˆ</button>
        </div>

        <!-- è¿›åº¦æ˜¾ç¤º -->
        <div class="progress-section" id="progressSection" style="display: none;">
          <div class="progress-text">
            <span id="progressText">å‡†å¤‡ä¸­...</span>
            <span style="float: right;" id="remainingTime">--:--:--</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="completedFiles">0</div>
              <div class="stat-label">å·²å®Œæˆ</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="failedFiles">0</div>
              <div class="stat-label">å¤±è´¥</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="totalSize">0 MB</div>
              <div class="stat-label">æ€»å¤§å°</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="uploadedSize">0 MB</div>
              <div class="stat-label">å·²ä¸Šä¼ </div>
            </div>
          </div>
        </div>

        <!-- æ–‡ä»¶åˆ—è¡¨ -->
        <div class="card">
          <h3>ğŸ“‹ æ–‡ä»¶åˆ—è¡¨</h3>
          <div class="file-list" id="fileList">
            <div style="text-align: center; color: #666; padding: 20px;">
              æš‚æ— æ–‡ä»¶ï¼Œè¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶
            </div>
          </div>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="card">
          <h3>ğŸ“ æ“ä½œæ—¥å¿—</h3>
          <div class="log-container" id="logContainer">
            <div class="log-entry">
              <span class="log-timestamp">[ç³»ç»Ÿ]</span> ç³»ç»Ÿå·²å°±ç»ªï¼Œç­‰å¾…æ–‡ä»¶ä¸Šä¼ ...
            </div>
          </div>
        </div>
      </div>

      <!-- ä¾§è¾¹æ  -->
      <div class="sidebar">
        <!-- ä»»åŠ¡ç®¡ç† -->
        <div class="card">
          <h3>ğŸ“Š ä»»åŠ¡ç®¡ç†</h3>
          <div class="button-group">
            <button class="button button-secondary" onclick="refreshServerTasks()">åˆ·æ–°ä»»åŠ¡</button>
            <button class="button button-warning" onclick="cleanupTasks()">æ¸…ç†ä»»åŠ¡</button>
          </div>
          <div class="task-list" id="serverTaskList">
            <div style="text-align: center; color: #666; padding: 20px;">
              ç‚¹å‡»åˆ·æ–°åŠ è½½æœåŠ¡å™¨ä»»åŠ¡
            </div>
          </div>
        </div>

        <!-- ç³»ç»Ÿç›‘æ§ -->
        <div class="card">
          <h3>ğŸ“ˆ ç³»ç»Ÿç›‘æ§</h3>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="totalTasks">0</div>
              <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="successRate">0%</div>
              <div class="stat-label">æˆåŠŸç‡</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="diskUsage">0%</div>
              <div class="stat-label">ç£ç›˜ä½¿ç”¨</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="goroutines">0</div>
              <div class="stat-label">åç¨‹æ•°</div>
            </div>
          </div>
          <button class="button button-secondary" onclick="showSystemInfo()" style="width: 100%;">è¯¦ç»†ä¿¡æ¯</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç³»ç»Ÿä¿¡æ¯æ¨¡æ€æ¡† -->
  <div id="systemModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯</h2>
      <div id="systemInfoContent">
        æ­£åœ¨åŠ è½½ç³»ç»Ÿä¿¡æ¯...
      </div>
    </div>
  </div>

  <!-- ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>ğŸ“‹ ä»»åŠ¡è¯¦æƒ…</h2>
      <div id="taskDetailContent">
        æ­£åœ¨åŠ è½½ä»»åŠ¡è¯¦æƒ…...
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let CHUNK_SIZE = 10 * 1024 * 1024; // 10MB
    let uploadQueue = [];
    let isUploading = false;
    let isPaused = false;
    let cancelFlag = false;
    let concurrentLimit = 3;
    let enableMD5Check = true;
    let retryCount = 3;
    let activeTasks = 0;
    let completedTasks = 0;
    let failedTasks = 0;
    let startTime = 0;
    let totalUploadedBytes = 0;
    let lastUploadedBytes = 0;
    let lastSpeedUpdate = 0;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initializeSystem();
      setupEventListeners();
      startMonitoring();
    });

    function initializeSystem() {
      log('ç³»ç»Ÿåˆå§‹åŒ–ä¸­...', 'info');
      checkSystemHealth();
      refreshServerTasks();
      updateSystemStatus();
    }

    function setupEventListeners() {
      // æ–‡ä»¶é€‰æ‹©
      document.getElementById('fileInput').addEventListener('change', handleFileSelect);
      document.getElementById('folderInput').addEventListener('change', handleFileSelect);

      // æ‹–æ‹½ä¸Šä¼ 
      const uploadArea = document.getElementById('uploadArea');
      uploadArea.addEventListener('dragover', handleDragOver);
      uploadArea.addEventListener('dragleave', handleDragLeave);
      uploadArea.addEventListener('drop', handleDrop);
      uploadArea.addEventListener('click', () => document.getElementById('fileInput').click());

      // é…ç½®å˜æ›´
      document.getElementById('chunkSizeSelect').addEventListener('change', updateChunkSize);
      document.getElementById('concurrentSelect').addEventListener('change', updateConcurrentLimit);
      document.getElementById('enableMD5').addEventListener('change', updateMD5Setting);
      document.getElementById('retryCount').addEventListener('change', updateRetryCount);

      // çª—å£å…³é—­å‰ä¿å­˜çŠ¶æ€
      window.addEventListener('beforeunload', (e) => {
        if (isUploading) {
          e.preventDefault();
          e.returnValue = 'ä¸Šä¼ æ­£åœ¨è¿›è¡Œä¸­ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
        }
      });
    }

    function startMonitoring() {
      // æ¯5ç§’æ›´æ–°ç³»ç»ŸçŠ¶æ€
      setInterval(updateSystemStatus, 5000);
      // æ¯30ç§’æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€
      setInterval(checkSystemHealth, 30000);
      // æ¯ç§’æ›´æ–°ä¸Šä¼ é€Ÿåº¦
      setInterval(updateUploadSpeed, 1000);
    }

    // æ–‡ä»¶å¤„ç†
    function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      addFilesToQueue(files);
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.currentTarget.classList.add('dragover');
    }

    function handleDragLeave(event) {
      event.currentTarget.classList.remove('dragover');
    }

    function handleDrop(event) {
      event.preventDefault();
      event.currentTarget.classList.remove('dragover');
      
      const files = Array.from(event.dataTransfer.files);
      addFilesToQueue(files);
    }

    function addFilesToQueue(files) {
      for (const file of files) {
        uploadQueue.push({
          file: file,
          status: 'pending',
          progress: 0,
          uploadedBytes: 0,
          fileId: generateFileId(file)
        });
      }
      
      updateFileList();
      log(`æ·»åŠ äº† ${files.length} ä¸ªæ–‡ä»¶åˆ°ä¸Šä¼ é˜Ÿåˆ—`, 'info');
      showNotification(`å·²æ·»åŠ  ${files.length} ä¸ªæ–‡ä»¶`, 'success');
    }

    function generateFileId(file) {
      const relativePath = file.webkitRelativePath || file.name;
      return `${relativePath}-${file.size}-${Date.now()}`;
    }

    function updateFileList() {
      const fileList = document.getElementById('fileList');
      
      if (uploadQueue.length === 0) {
        fileList.innerHTML = `
          <div style="text-align: center; color: #666; padding: 20px;">
            æš‚æ— æ–‡ä»¶ï¼Œè¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶
          </div>
        `;
        return;
      }

      const totalSize = uploadQueue.reduce((sum, item) => sum + item.file.size, 0);
      
      let html = `
        <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
          <strong>å…± ${uploadQueue.length} ä¸ªæ–‡ä»¶ï¼Œæ€»å¤§å°: ${formatFileSize(totalSize)}</strong>
        </div>
      `;

      uploadQueue.forEach((item, index) => {
        const statusClass = `status-${item.status}`;
        const statusText = getStatusText(item.status);
        
        html += `
          <div class="file-item">
            <div class="file-info">
              <div class="file-name" title="${item.file.webkitRelativePath || item.file.name}">
                ${item.file.webkitRelativePath || item.file.name}
              </div>
              <div class="file-size">
                ${formatFileSize(item.file.size)} 
                ${item.progress > 0 ? `(${item.progress}%)` : ''}
              </div>
            </div>
            <div class="file-status ${statusClass}">${statusText}</div>
          </div>
        `;
      });

      fileList.innerHTML = html;
    }

    function getStatusText(status) {
      const statusMap = {
        'pending': 'ç­‰å¾…',
        'uploading': 'ä¸Šä¼ ä¸­',
        'completed': 'å®Œæˆ',
        'error': 'å¤±è´¥',
        'paused': 'æš‚åœ'
      };
      return statusMap[status] || 'æœªçŸ¥';
    }

    // é…ç½®æ›´æ–°
    function updateChunkSize() {
      const sizeInMB = parseInt(document.getElementById('chunkSizeSelect').value);
      CHUNK_SIZE = sizeInMB * 1024 * 1024;
      log(`åˆ†ç‰‡å¤§å°è°ƒæ•´ä¸º: ${sizeInMB}MB`, 'info');
    }

    function updateConcurrentLimit() {
      concurrentLimit = parseInt(document.getElementById('concurrentSelect').value);
      log(`å¹¶å‘æ•°é‡è°ƒæ•´ä¸º: ${concurrentLimit}`, 'info');
    }

    function updateMD5Setting() {
      enableMD5Check = document.getElementById('enableMD5').value === 'true';
      log(`MD5æ ¡éªŒ${enableMD5Check ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}`, 'info');
    }

    function updateRetryCount() {
      retryCount = parseInt(document.getElementById('retryCount').value);
      log(`é‡è¯•æ¬¡æ•°è°ƒæ•´ä¸º: ${retryCount}`, 'info');
    }

    // ä¸Šä¼ æ§åˆ¶
    async function startUpload() {
      if (uploadQueue.length === 0) {
        showNotification('è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶', 'warning');
        return;
      }

      if (isUploading && !isPaused) {
        showNotification('ä¸Šä¼ æ­£åœ¨è¿›è¡Œä¸­', 'warning');
        return;
      }

      isUploading = true;
      isPaused = false;
      cancelFlag = false;
      startTime = Date.now();
      lastUploadedBytes = totalUploadedBytes;
      lastSpeedUpdate = Date.now();

      updateUploadControls();
      document.getElementById('progressSection').style.display = 'block';

      log(`å¼€å§‹${document.getElementById('uploadBtn').textContent === 'ç»§ç»­ä¸Šä¼ ' ? 'ç»§ç»­' : ''}ä¸Šä¼ ï¼Œå…± ${uploadQueue.length} ä¸ªæ–‡ä»¶`, 'info');

      try {
        await concurrentUpload();
        log(`ä¸Šä¼ å®Œæˆ: ${completedTasks}/${uploadQueue.length} ä¸ªæ–‡ä»¶æˆåŠŸ`, 'success');
        showNotification('æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼', 'success');
      } catch (error) {
        log(`ä¸Šä¼ å‡ºé”™: ${error.message}`, 'error');
        showNotification('ä¸Šä¼ è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯', 'error');
      } finally {
        isUploading = false;
        updateUploadControls();
        refreshServerTasks();
      }
    }

    function pauseUpload() {
      isPaused = true;
      log('ä¸Šä¼ å·²æš‚åœ', 'warning');
      showNotification('ä¸Šä¼ å·²æš‚åœ', 'info');
      updateUploadControls();
    }

    function cancelUpload() {
      if (confirm('ç¡®å®šè¦å–æ¶ˆæ‰€æœ‰ä¸Šä¼ ä»»åŠ¡å—ï¼Ÿ')) {
        cancelFlag = true;
        isPaused = false;
        isUploading = false;
        log('ç”¨æˆ·å–æ¶ˆä¸Šä¼ ', 'warning');
        showNotification('ä¸Šä¼ å·²å–æ¶ˆ', 'warning');
        updateUploadControls();
      }
    }

    function updateUploadControls() {
      const uploadBtn = document.getElementById('uploadBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const cancelBtn = document.getElementById('cancelBtn');

      if (isUploading && !isPaused) {
        uploadBtn.style.display = 'none';
        pauseBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
      } else if (isPaused) {
        uploadBtn.style.display = 'inline-block';
        uploadBtn.textContent = 'ç»§ç»­ä¸Šä¼ ';
        pauseBtn.style.display = 'none';
        cancelBtn.style.display = 'inline-block';
      } else {
        uploadBtn.style.display = 'inline-block';
        uploadBtn.textContent = 'å¼€å§‹ä¸Šä¼ ';
        pauseBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
      }
    }

    // å¹¶å‘ä¸Šä¼ 
    async function concurrentUpload() {
      const pendingFiles = uploadQueue.filter(item => item.status === 'pending' || item.status === 'error');
      let index = 0;
      const workers = [];

      for (let i = 0; i < concurrentLimit; i++) {
        workers.push(uploadWorker());
      }

      async function uploadWorker() {
        while (index < pendingFiles.length && !cancelFlag && !isPaused) {
          const fileIndex = index++;
          const item = pendingFiles[fileIndex];

          if (!item || (item.status !== 'pending' && item.status !== 'error')) continue;

          activeTasks++;
          item.status = 'uploading';
          updateFileList();
          updateProgress();

          try {
            await uploadSingleFile(item);
            item.status = 'completed';
            item.progress = 100;
            completedTasks++;
            log(`âœ… å®Œæˆ: ${item.file.name}`, 'success');
          } catch (error) {
            item.status = 'error';
            failedTasks++;
            log(`âŒ å¤±è´¥: ${item.file.name} - ${error.message}`, 'error');
          }

          activeTasks--;
          updateFileList();
          updateProgress();
        }
      }

      await Promise.all(workers);
    }

    // å•æ–‡ä»¶ä¸Šä¼ 
    async function uploadSingleFile(item) {
      const file = item.file;
      const fileId = item.fileId;
      const totalChunks = Math.ceil(file.size / CHUNK_SIZE);

      // æ£€æŸ¥æœåŠ¡å™¨ä¸Šçš„ä¸Šä¼ çŠ¶æ€
      let uploadedChunks = [];
      try {
        const response = await fetchWithRetry(`/go-uploader/upload_status?file_id=${encodeURIComponent(fileId)}`);
        const data = await response.json();
        uploadedChunks = data.uploaded_chunks || [];
      } catch (error) {
        log(`è·å–ä¸Šä¼ çŠ¶æ€å¤±è´¥: ${error.message}`, 'warning');
      }

      // ä¸Šä¼ åˆ†ç‰‡
      for (let i = 0; i < totalChunks; i++) {
        if (cancelFlag || isPaused) {
          throw new Error('ä¸Šä¼ è¢«ä¸­æ–­');
        }

        if (uploadedChunks.includes(i)) {
          continue; // è·³è¿‡å·²ä¸Šä¼ çš„åˆ†ç‰‡
        }

        const start = i * CHUNK_SIZE;
        const end = Math.min(file.size, start + CHUNK_SIZE);
        const chunk = file.slice(start, end);

        await uploadChunk(fileId, i, chunk, file, item);
        
        // æ›´æ–°è¿›åº¦
        item.progress = Math.round(((i + 1) / totalChunks) * 100);
        item.uploadedBytes = (i + 1) * CHUNK_SIZE;
        updateFileList();
      }

      // åˆå¹¶æ–‡ä»¶
      await mergeFile(fileId, file, totalChunks);
    }

    // ä¸Šä¼ åˆ†ç‰‡
    async function uploadChunk(fileId, chunkIndex, chunk, file, item) {
      const formData = new FormData();
      formData.append('file_id', fileId);
      formData.append('chunk_index', chunkIndex);
      formData.append('chunk', chunk);
      formData.append('relative_path', file.webkitRelativePath || file.name);
      formData.append('total_chunks', Math.ceil(file.size / CHUNK_SIZE));
      formData.append('file_size', file.size);

      if (enableMD5Check) {
        const md5 = await calculateMD5(chunk);
        formData.append('md5', md5);
      }

      const response = await fetchWithRetry('/go-uploader/upload_chunk', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || `ä¸Šä¼ åˆ†ç‰‡ ${chunkIndex} å¤±è´¥: ${response.status}`);
      }

      totalUploadedBytes += chunk.size;
    }

    // åˆå¹¶æ–‡ä»¶
    async function mergeFile(fileId, file, totalChunks) {
      const formData = new FormData();
      formData.append('file_id', fileId);
      formData.append('filename', file.name);
      formData.append('total_chunks', totalChunks);
      formData.append('relative_path', file.webkitRelativePath || file.name);

      const response = await fetchWithRetry('/go-uploader/merge_chunks', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || `åˆå¹¶æ–‡ä»¶å¤±è´¥: ${response.status}`);
      }

      const result = await response.json();
      log(`æ–‡ä»¶åˆå¹¶æˆåŠŸ: ${result.filePath}`, 'success');
      return result;
    }

    // å¸¦é‡è¯•çš„ç½‘ç»œè¯·æ±‚
    async function fetchWithRetry(url, options = {}, attempts = retryCount) {
      for (let i = 0; i < attempts; i++) {
        try {
          const response = await fetch(url, options);
          if (response.ok) {
            return response;
          }
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        } catch (error) {
          if (i === attempts - 1) {
            throw error;
          }
          
          const delay = Math.min(1000 * Math.pow(2, i), 10000);
          log(`è¯·æ±‚å¤±è´¥ï¼Œ${delay}ms åé‡è¯• (${i + 1}/${attempts}): ${error.message}`, 'warning');
          await sleep(delay);
        }
      }
    }

    // è®¡ç®—æ–‡ä»¶MD5
    async function calculateMD5(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            const buffer = e.target.result;
            const hashBuffer = await crypto.subtle.digest('MD5', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            resolve(hashHex);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    // æœåŠ¡å™¨ä»»åŠ¡ç®¡ç†
    async function refreshServerTasks() {
      try {
        const response = await fetch('/go-uploader/tasks');
        const data = await response.json();
        
        updateServerTaskList(data.tasks || []);
        updateTaskStats(data.tasks || []);
      } catch (error) {
        log(`è·å–æœåŠ¡å™¨ä»»åŠ¡å¤±è´¥: ${error.message}`, 'error');
      }
    }

    function updateServerTaskList(tasks) {
      const taskList = document.getElementById('serverTaskList');
      
      if (tasks.length === 0) {
        taskList.innerHTML = `
          <div style="text-align: center; color: #666; padding: 20px;">
            æš‚æ— æœåŠ¡å™¨ä»»åŠ¡
          </div>
        `;
        return;
      }

      let html = '';
      tasks.forEach(task => {
        const progressPercent = task.completion_rate || 0;
        const statusClass = `status-${task.status}`;
        
        html += `
          <div class="task-item">
            <div class="task-header">
              <div class="task-name" title="${task.filename}">${task.filename}</div>
              <div class="task-actions">
                <button class="button button-secondary" onclick="showTaskDetail('${task.file_id}')">è¯¦æƒ…</button>
                ${task.status === 'paused' || task.status === 'failed' ? 
                  `<button class="button button-success" onclick="resumeTask('${task.file_id}')">æ¢å¤</button>` : ''}
                ${task.status === 'uploading' ? 
                  `<button class="button button-warning" onclick="pauseTask('${task.file_id}')">æš‚åœ</button>` : ''}
                <button class="button button-danger" onclick="deleteTask('${task.file_id}')">åˆ é™¤</button>
              </div>
            </div>
            <div class="task-progress">
              <div class="task-progress-fill" style="width: ${progressPercent}%"></div>
            </div>
            <div class="task-info">
              <span class="file-status ${statusClass}">${getStatusText(task.status)}</span>
              <span>${formatFileSize(task.file_size)}</span>
              <span>${progressPercent.toFixed(1)}%</span>
            </div>
          </div>
        `;
      });

      taskList.innerHTML = html;
    }

    function updateTaskStats(tasks) {
      const totalTasks = tasks.length;
      const completedTasks = tasks.filter(t => t.status === 'completed').length;
      const successRate = totalTasks > 0 ? (completedTasks / totalTasks * 100).toFixed(1) : 0;

      document.getElementById('totalTasks').textContent = totalTasks;
      document.getElementById('successRate').textContent = successRate + '%';
    }

    async function pauseTask(fileId) {
      try {
        const response = await fetch(`/go-uploader/tasks/${fileId}/pause`, {
          method: 'POST'
        });
        
        if (response.ok) {
          showNotification('ä»»åŠ¡å·²æš‚åœ', 'success');
          refreshServerTasks();
        } else {
          const error = await response.json();
          showNotification(error.error || 'æš‚åœä»»åŠ¡å¤±è´¥', 'error');
        }
      } catch (error) {
        showNotification('æš‚åœä»»åŠ¡å¤±è´¥', 'error');
      }
    }

    async function resumeTask(fileId) {
      try {
        const response = await fetch(`/go-uploader/tasks/${fileId}/resume`, {
          method: 'POST'
        });
        
        if (response.ok) {
          showNotification('ä»»åŠ¡å·²æ¢å¤', 'success');
          refreshServerTasks();
        } else {
          const error = await response.json();
          showNotification(error.error || 'æ¢å¤ä»»åŠ¡å¤±è´¥', 'error');
        }
      } catch (error) {
        showNotification('æ¢å¤ä»»åŠ¡å¤±è´¥', 'error');
      }
    }

    async function deleteTask(fileId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
        return;
      }
      
      try {
        const response = await fetch(`/go-uploader/tasks/${fileId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showNotification('ä»»åŠ¡å·²åˆ é™¤', 'success');
          refreshServerTasks();
        } else {
          const error = await response.json();
          showNotification(error.error || 'åˆ é™¤ä»»åŠ¡å¤±è´¥', 'error');
        }
      } catch (error) {
        showNotification('åˆ é™¤ä»»åŠ¡å¤±è´¥', 'error');
      }
    }

    async function cleanupTasks() {
      if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰å·²å®Œæˆå’Œå¤±è´¥çš„ä»»åŠ¡å—ï¼Ÿ')) {
        return;
      }
      
      try {
        const response = await fetch('/go-uploader/tasks/cleanup', {
          method: 'POST'
        });
        
        if (response.ok) {
          const result = await response.json();
          showNotification(result.message, 'success');
          refreshServerTasks();
        } else {
          const error = await response.json();
          showNotification(error.error || 'æ¸…ç†ä»»åŠ¡å¤±è´¥', 'error');
        }
      } catch (error) {
        showNotification('æ¸…ç†ä»»åŠ¡å¤±è´¥', 'error');
      }
    }

    async function showTaskDetail(fileId) {
      try {
        const response = await fetch(`/go-uploader/tasks/${fileId}`);
        const task = await response.json();
        
        let html = `
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value">${task.filename}</div>
              <div class="stat-label">æ–‡ä»¶å</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">${formatFileSize(task.file_size)}</div>
              <div class="stat-label">æ–‡ä»¶å¤§å°</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">${task.completion_rate?.toFixed(1) || 0}%</div>
              <div class="stat-label">å®Œæˆåº¦</div>
            </div>
            <div class="stat-item">
              <div class="stat-value status-${task.status}">${getStatusText(task.status)}</div>
              <div class="stat-label">çŠ¶æ€</div>
            </div>
          </div>
          <p><strong>æ–‡ä»¶ID:</strong> ${task.file_id}</p>
          <p><strong>ç›¸å¯¹è·¯å¾„:</strong> ${task.relative_path || 'æ— '}</p>
          <p><strong>æ€»åˆ†ç‰‡æ•°:</strong> ${task.total_chunks}</p>
          <p><strong>å·²ä¸Šä¼ åˆ†ç‰‡:</strong> ${task.uploaded_chunks?.length || 0}</p>
          <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(task.created_at).toLocaleString()}</p>
          <p><strong>æ›´æ–°æ—¶é—´:</strong> ${new Date(task.updated_at).toLocaleString()}</p>
          <p><strong>é‡è¯•æ¬¡æ•°:</strong> ${task.retry_count || 0}</p>
          ${task.file_md5 ? `<p><strong>æ–‡ä»¶MD5:</strong> ${task.file_md5}</p>` : ''}
        `;
        
        document.getElementById('taskDetailContent').innerHTML = html;
        document.getElementById('taskModal').style.display = 'block';
      } catch (error) {
        showNotification('è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥', 'error');
      }
    }

    // ç³»ç»Ÿç›‘æ§
    async function checkSystemHealth() {
      try {
        const response = await fetch('/go-uploader/health');
        const health = await response.json();
        
        const indicator = document.getElementById('healthIndicator');
        const statusText = document.getElementById('systemStatus');
        
        indicator.className = `health-indicator health-${health.status}`;
        statusText.textContent = health.status === 'healthy' ? 'æ­£å¸¸' : 
                                 health.status === 'warning' ? 'è­¦å‘Š' : 'å¼‚å¸¸';
      } catch (error) {
        const indicator = document.getElementById('healthIndicator');
        const statusText = document.getElementById('systemStatus');
        
        indicator.className = 'health-indicator health-unhealthy';
        statusText.textContent = 'ç¦»çº¿';
      }
    }

    async function updateSystemStatus() {
      try {
        const response = await fetch('/go-uploader/metrics');
        const metrics = await response.json();
        
        document.getElementById('activeTasks').textContent = metrics.metrics.active_tasks || 0;
        document.getElementById('memoryUsage').textContent = metrics.metrics.memory_mb + ' MB';
        document.getElementById('goroutines').textContent = metrics.metrics.goroutines || 0;
        
        // æ›´æ–°ç£ç›˜ä½¿ç”¨ç‡
        const systemResponse = await fetch('/go-uploader/system');
        const systemData = await systemResponse.json();
        
        if (systemData.disk_usage && systemData.disk_usage.usage_percent) {
          document.getElementById('diskUsage').textContent = 
            systemData.disk_usage.usage_percent.toFixed(1) + '%';
        }
      } catch (error) {
        // é™é»˜å¤„ç†ç›‘æ§æ•°æ®è·å–å¤±è´¥
      }
    }

    function updateUploadSpeed() {
      if (!isUploading || isPaused) {
        document.getElementById('uploadSpeed').textContent = '0 MB/s';
        return;
      }

      const now = Date.now();
      const timeDiff = (now - lastSpeedUpdate) / 1000; // ç§’
      const bytesDiff = totalUploadedBytes - lastUploadedBytes;
      
      if (timeDiff >= 1) {
        const speed = bytesDiff / timeDiff; // å­—èŠ‚/ç§’
        const speedMB = speed / (1024 * 1024); // MB/s
        
        document.getElementById('uploadSpeed').textContent = speedMB.toFixed(2) + ' MB/s';
        
        lastUploadedBytes = totalUploadedBytes;
        lastSpeedUpdate = now;
      }
    }

    async function showSystemInfo() {
      try {
        const response = await fetch('/go-uploader/system');
        const data = await response.json();
        
        let html = `
          <h3>ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯</h3>
          <p><strong>Goç‰ˆæœ¬:</strong> ${data.system.go_version}</p>
          <p><strong>åç¨‹æ•°:</strong> ${data.system.goroutines}</p>
          <p><strong>å†…å­˜åˆ†é…:</strong> ${data.system.memory_alloc} MB</p>
          <p><strong>ç³»ç»Ÿå†…å­˜:</strong> ${data.system.memory_sys} MB</p>
          <p><strong>GCè¿è¡Œæ¬¡æ•°:</strong> ${data.system.gc_runs}</p>
          
          <h3>âš™ï¸ é…ç½®ä¿¡æ¯</h3>
          <p><strong>ä¸Šä¼ ç›®å½•:</strong> ${data.config.upload_dir}</p>
          <p><strong>åˆå¹¶ç›®å½•:</strong> ${data.config.merged_dir}</p>
          <p><strong>æœ€å¤§æ–‡ä»¶å¤§å°:</strong> ${formatFileSize(data.config.max_file_size)}</p>
          <p><strong>æœ€å¤§åˆ†ç‰‡å¤§å°:</strong> ${formatFileSize(data.config.max_chunk_size)}</p>
          <p><strong>å¹¶å‘ä¸Šä¼ æ•°:</strong> ${data.config.concurrent_uploads}</p>
          <p><strong>å®Œæ•´æ€§æ£€æŸ¥:</strong> ${data.config.enable_integrity_check ? 'å¯ç”¨' : 'ç¦ç”¨'}</p>
          <p><strong>åŸå­æ“ä½œ:</strong> ${data.config.enable_atomic_operations ? 'å¯ç”¨' : 'ç¦ç”¨'}</p>
          
          <h3>ğŸ“Š ç£ç›˜ä½¿ç”¨</h3>
          <p><strong>ä¸Šä¼ ç›®å½•å¤§å°:</strong> ${formatFileSize(data.disk_usage.upload_dir_size || 0)}</p>
          <p><strong>åˆå¹¶ç›®å½•å¤§å°:</strong> ${formatFileSize(data.disk_usage.merged_dir_size || 0)}</p>
          <p><strong>æ€»ä½¿ç”¨é‡:</strong> ${formatFileSize(data.disk_usage.total_used || 0)}</p>
          <p><strong>ä½¿ç”¨ç‡:</strong> ${(data.disk_usage.usage_percent || 0).toFixed(2)}%</p>
        `;
        
        document.getElementById('systemInfoContent').innerHTML = html;
        document.getElementById('systemModal').style.display = 'block';
      } catch (error) {
        showNotification('è·å–ç³»ç»Ÿä¿¡æ¯å¤±è´¥', 'error');
      }
    }

    // è¿›åº¦æ›´æ–°
    function updateProgress() {
      const totalFiles = uploadQueue.length;
      const completed = uploadQueue.filter(item => item.status === 'completed').length;
      const failed = uploadQueue.filter(item => item.status === 'error').length;
      const progress = totalFiles > 0 ? (completed / totalFiles) * 100 : 0;
      
      // æ›´æ–°è¿›åº¦æ¡
      document.getElementById('progressFill').style.width = progress + '%';
      document.getElementById('progressText').textContent = 
        `${completed}/${totalFiles} (${progress.toFixed(1)}%)`;
      
      // æ›´æ–°ç»Ÿè®¡
      document.getElementById('completedFiles').textContent = completed;
      document.getElementById('failedFiles').textContent = failed;
      
      const totalSize = uploadQueue.reduce((sum, item) => sum + item.file.size, 0);
      const uploadedSize = uploadQueue
        .filter(item => item.status === 'completed')
        .reduce((sum, item) => sum + item.file.size, 0);
      
      document.getElementById('totalSize').textContent = formatFileSize(totalSize);
      document.getElementById('uploadedSize').textContent = formatFileSize(uploadedSize);
      
      // è®¡ç®—å‰©ä½™æ—¶é—´
      if (completed > 0 && startTime > 0) {
        const elapsed = (Date.now() - startTime) / 1000;
        const rate = completed / elapsed;
        const remaining = (totalFiles - completed) / rate;
        document.getElementById('remainingTime').textContent = formatTime(remaining);
      } else {
        document.getElementById('remainingTime').textContent = '--:--:--';
      }
    }

    // æ¨¡æ€æ¡†æ§åˆ¶
    function closeModal() {
      document.getElementById('systemModal').style.display = 'none';
      document.getElementById('taskModal').style.display = 'none';
    }

    window.onclick = function(event) {
      const systemModal = document.getElementById('systemModal');
      const taskModal = document.getElementById('taskModal');
      
      if (event.target === systemModal) {
        systemModal.style.display = 'none';
      }
      if (event.target === taskModal) {
        taskModal.style.display = 'none';
      }
    }

    // é€šçŸ¥ç³»ç»Ÿ
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => notification.classList.add('show'), 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => document.body.removeChild(notification), 300);
      }, 3000);
    }

    // æ—¥å¿—ç³»ç»Ÿ
    function log(message, level = 'info') {
      const logContainer = document.getElementById('logContainer');
      const timestamp = new Date().toLocaleTimeString();
      
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${level}`;
      logEntry.innerHTML = `
        <span class="log-timestamp">[${timestamp}]</span> ${message}
      `;
      
      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;
      
      // é™åˆ¶æ—¥å¿—æ¡æ•°
      const entries = logContainer.querySelectorAll('.log-entry');
      if (entries.length > 100) {
        logContainer.removeChild(entries[0]);
      }
    }

    // å·¥å…·å‡½æ•°
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatTime(seconds) {
      if (!seconds || seconds === Infinity || isNaN(seconds)) return '--:--:--';
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
  </script>
</body>
</html>
