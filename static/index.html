<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¼ä¸šçº§æ–‡ä»¶ä¸Šä¼ ç³»ç»Ÿ</title>
  
  <!-- Tailwind CSS -->
  <script src="/go-uploader/static/js/tailwind-3.4.16.js"></script>
  
  <!-- Alpine.js -->
  <script defer src="/go-uploader/static/js/alpinejs-3.14.9.js"></script>
  
  <!-- Spark MD5 for file hashing -->
  <script src="/go-uploader/static/js/spark-md5.min.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            }
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'bounce-slow': 'bounce 2s infinite',
          }
        }
      }
    }
  </script>
  
  <style>
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .progress-shimmer::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    .card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .notification-enter {
      transform: translateX(100%);
      opacity: 0;
    }
    
    .notification-enter-active {
      transform: translateX(0);
      opacity: 1;
      transition: all 0.3s ease-out;
    }
    
    .notification-leave-active {
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease-in;
    }
  </style>
</head>

<body class="min-h-screen bg-gray-50">
  <!-- å¯†é’¥éªŒè¯ç•Œé¢ -->
  <div x-data="authApp()" x-show="!$store.auth.isAuthenticated" class="min-h-screen flex items-center justify-center bg-gray-50">
    <div class="max-w-md w-full space-y-8">
      <div>
        <div class="mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-blue-100">
          <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
          </svg>
        </div>
        <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
          æ–‡ä»¶ä¸Šä¼ ç³»ç»Ÿ
        </h2>
        <p class="mt-2 text-center text-sm text-gray-600">
          è¯·è¾“å…¥è®¿é—®å¯†é’¥ä»¥ç»§ç»­
        </p>
      </div>
      <form class="mt-8 space-y-6" @submit.prevent="login()">
        <div>
          <label for="secret-key" class="sr-only">è®¿é—®å¯†é’¥</label>
          <input id="secret-key" 
                 x-model="secretKey" 
                 name="secretKey" 
                 type="password" 
                 required 
                 class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" 
                 placeholder="è¯·è¾“å…¥è®¿é—®å¯†é’¥">
        </div>
        <div>
          <button type="submit" 
                  :disabled="isLoading"
                  class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
            <span x-show="!isLoading">ğŸ” ç™»å½•</span>
            <span x-show="isLoading">â³ éªŒè¯ä¸­...</span>
          </button>
        </div>
        <div x-show="errorMessage" class="text-red-600 text-sm text-center" x-text="errorMessage"></div>
      </form>
    </div>
  </div>

  <!-- ä¸»åº”ç”¨ç•Œé¢ -->
  <div x-data="fileUploadApp()" x-init="init()" x-show="$store.auth.isAuthenticated" class="container mx-auto px-4 py-4 max-w-6xl">
    
    <!-- ç³»ç»ŸçŠ¶æ€å¤´éƒ¨ -->
    <div class="card p-4 mb-4">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold text-gray-800">
          æ–‡ä»¶ä¸Šä¼ ç³»ç»Ÿ
        </h1>
        <button @click="logout()" 
                class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition-colors duration-200">
          ğŸšª ç™»å‡º
        </button>
      </div>
      
      <!-- ç³»ç»ŸçŠ¶æ€æŒ‡ç¤ºå™¨ -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="text-center p-3 rounded-lg bg-blue-50 border border-blue-200">
          <div class="flex items-center justify-center mb-1">
            <div class="w-2 h-2 rounded-full mr-1" 
                 :class="systemHealth === 'healthy' ? 'bg-green-500' : 
                         systemHealth === 'warning' ? 'bg-yellow-500' : 'bg-red-500'"></div>
            <span class="text-gray-700 text-sm font-medium">ç³»ç»ŸçŠ¶æ€</span>
    </div>
          <div class="text-lg font-bold text-gray-800" x-text="systemHealthText"></div>
    </div>
        
        <div class="text-center p-3 rounded-lg bg-green-50 border border-green-200">
          <span class="text-gray-700 text-sm font-medium block mb-1">æ´»è·ƒä»»åŠ¡</span>
          <div class="text-lg font-bold text-gray-800" x-text="metrics.activeTasks"></div>
    </div>
        
        <div class="text-center p-3 rounded-lg bg-purple-50 border border-purple-200">
          <span class="text-gray-700 text-sm font-medium block mb-1">å†…å­˜ä½¿ç”¨</span>
          <div class="text-lg font-bold text-gray-800" x-text="metrics.memoryUsage + ' MB'"></div>
  </div>
  
        <div class="text-center p-3 rounded-lg bg-orange-50 border border-orange-200">
          <span class="text-gray-700 text-sm font-medium block mb-1">ä¸Šä¼ é€Ÿåº¦</span>
          <div class="text-lg font-bold text-gray-800" x-text="formatSpeed(uploadSpeed)"></div>
        </div>
      </div>
  </div>
  
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
      
      <!-- ä¸»ä¸Šä¼ é¢æ¿ -->
      <div class="lg:col-span-3 space-y-4">
        
        <!-- é…ç½®é¢æ¿ -->
        <div class="card p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
            âš™ï¸ ä¸Šä¼ é…ç½®
          </h3>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div>
              <label class="block text-gray-700 text-sm font-medium mb-1">åˆ†ç‰‡å¤§å°</label>
              <select x-model="config.chunkSize" @change="updateChunkSize()" 
                      class="w-full px-2 py-1 bg-white border border-gray-300 rounded text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="5">5MB</option>
                <option value="10">10MB</option>
                <option value="20">20MB</option>
                <option value="50">50MB</option>
                <option value="100">100MB</option>
              </select>
            </div>
  
            <div>
              <label class="block text-gray-700 text-sm font-medium mb-1">å¹¶å‘æ•°é‡</label>
              <select x-model="config.concurrent" 
                      class="w-full px-2 py-1 bg-white border border-gray-300 rounded text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            
            <div>
              <label class="block text-gray-700 text-sm font-medium mb-1">MD5æ ¡éªŒ</label>
              <select x-model="config.enableMD5" 
                      class="w-full px-2 py-1 bg-white border border-gray-300 rounded text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="true">å¯ç”¨</option>
                <option value="false">ç¦ç”¨</option>
              </select>
            </div>
  
            <div>
              <label class="block text-gray-700 text-sm font-medium mb-1">é‡è¯•æ¬¡æ•°</label>
              <select x-model="config.retryCount" 
                      class="w-full px-2 py-1 bg-white border border-gray-300 rounded text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="1">1æ¬¡</option>
                <option value="3">3æ¬¡</option>
                <option value="5">5æ¬¡</option>
                <option value="10">10æ¬¡</option>
              </select>
            </div>
          </div>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="card p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“‹ ä»»åŠ¡åˆ—è¡¨</h3>
          <input type="file" 
                 x-ref="fileInput" 
                 @change="handleFileSelect($event)" 
                 multiple 
                 class="hidden">
          <input type="file" 
                 x-ref="folderInput" 
                 @change="handleFolderSelect($event)" 
                 webkitdirectory
                 class="hidden">
  
          <!-- æ“ä½œæŒ‰é’® -->
          <div class="flex flex-wrap gap-2">
            <button @click="selectFiles()" 
                    class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm transition-colors duration-200"
                    title="é€‰æ‹©æ–‡ä»¶è¿›è¡Œä¸Šä¼ ">
              ğŸ“„ ä¸Šä¼ æ–‡ä»¶
            </button>
            <button @click="selectFolder()" 
                    class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded text-sm transition-colors duration-200"
                    title="é€‰æ‹©æ–‡ä»¶å¤¹è¿›è¡Œä¸Šä¼ ">
              ğŸ“ ä¸Šä¼ æ–‡ä»¶å¤¹
            </button>
            <button @click="refreshServerTasks()" 
                    class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm transition-colors duration-200">
              ğŸ”„ åˆ·æ–°
            </button>
            <button @click="cleanupTasks()" 
                    class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded text-sm transition-colors duration-200">
              ğŸ§¹ æ¸…ç†
            </button>
            <button @click="resumeAllFailedTasks()" 
                    class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded text-sm transition-colors duration-200">
              ğŸ”„ æ¢å¤å¤±è´¥ä»»åŠ¡
            </button>
            <button @click="showFailedTasks()" 
                    class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition-colors duration-200">
              âŒ æŸ¥çœ‹å¤±è´¥ä»»åŠ¡
            </button>
          </div>
          
          <!-- ä»»åŠ¡çŠ¶æ€ç­›é€‰å™¨ -->
          <div x-show="(serverTasks || []).length > 0" class="mt-4 flex items-center gap-4">
            <span class="text-sm font-medium text-gray-700">çŠ¶æ€ç­›é€‰ï¼š</span>
            <select x-model="taskFilter" @change="filterTasks()" 
                    class="text-sm border border-gray-300 rounded px-2 py-1">
              <option value="all">å…¨éƒ¨ä»»åŠ¡</option>
              <option value="uploading">ä¸Šä¼ ä¸­</option>
              <option value="completed">å·²å®Œæˆ</option>
              <option value="failed">å¤±è´¥</option>
              <option value="partial_failed">éƒ¨åˆ†å¤±è´¥</option>
              <option value="paused">å·²æš‚åœ</option>
              <option value="pending">ç­‰å¾…ä¸­</option>
            </select>
            <span x-text="getFilteredTasksInfo()" class="text-sm text-gray-600"></span>
          </div>
          
          <!-- å¤±è´¥ä»»åŠ¡æé†’ -->
          <div x-show="getFailedTasksCount() > 0" 
               class="mt-2 p-3 bg-red-50 border border-red-200 rounded-lg flex items-center justify-between">
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
              </svg>
              <span class="text-red-700 font-medium" x-text="getFailedTasksMessage()"></span>
            </div>
            <button @click="resumeAllFailedTasks()" 
                    class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm">
              ä¸€é”®æ¢å¤
            </button>
          </div>
          
          <div x-show="(serverTasks || []).length === 0" class="text-center py-8 text-gray-500">
            æš‚æ— ä»»åŠ¡ï¼Œè¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶
          </div>
          
          <div x-show="(serverTasks || []).length > 0" class="space-y-2 max-h-96 overflow-y-auto">    
            <!-- æœåŠ¡å™¨ä»»åŠ¡åˆ—è¡¨ -->
            <template x-for="task in getFilteredTasks()" :key="task.task_id || task.file_id">
              <div>
                <div class="bg-gray-50 rounded p-3 flex items-center justify-between" 
                     :class="task.task_type === 'folder' ? 'border-l-4 border-purple-400' : 'border-l-4 border-blue-400'">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center space-x-2">
                      <span x-show="task.task_type === 'folder'">ğŸ“</span>
                      <span x-show="task.task_type === 'file'">ğŸ“„</span>
                      <div class="text-gray-800 font-medium truncate text-sm" 
                           x-text="task.folder_name || task.filename"></div>
                    </div>
                    <div class="text-gray-600 text-xs mt-1">
                      <span x-text="formatFileSize(task.file_size)"></span>
                      <span x-show="task.completion_rate > 0" x-text="'(' + (task.completion_rate || 0).toFixed(1) + '%)'"></span>
                      <span x-show="task.task_type === 'folder'" x-text="'- ' + (task.total_files || 0) + ' ä¸ªæ–‡ä»¶'"></span>
                      <span x-show="task.task_type === 'folder' && task.completed_files !== undefined" 
                            x-text="'- å·²å®Œæˆ ' + task.completed_files + '/' + task.total_files"></span>
                      <span x-show="!hasFileForTask(task) && (task.status === 'pending' || task.status === 'uploading')" 
                            class="text-orange-600 font-medium">- ç¼ºå°‘æ–‡ä»¶å¯¹è±¡</span>
                    </div>
                  </div>
                  
                  <div class="ml-3 flex items-center space-x-2">
                    <span class="px-2 py-1 rounded text-xs font-medium"
                          :class="getStatusClass(task.status)" 
                          x-text="getStatusText(task.status)"></span>
                  </div>
                </div>
                
                <!-- è¿›åº¦æ¡ -->
                <div x-show="task.completion_rate > 0" class="mt-2 px-3">
                  <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="h-full rounded-full transition-all duration-300" 
                         :class="task.task_type === 'folder' ? 'bg-purple-400' : 'bg-blue-400'"
                         :style="'width: ' + (task.completion_rate || 0) + '%'"></div>
                  </div>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="mt-2 px-3 flex gap-2">
                  <button x-show="!task.isPaused && !task.isUploading && (task.status === 'pending' || task.status === 'error') && hasFileForTask(task)" 
                          @click="startUpload(task)"
                          class="text-xs px-2 py-1 bg-green-500 hover:bg-green-600 text-white rounded">
                    å¼€å§‹
                  </button>
                  <button x-show="!task.isPaused && !task.isUploading && (task.status === 'waiting_files' || (task.status === 'pending' && !hasFileForTask(task)))" 
                          @click="selectRecoveryTask(task.task_id || task.file_id, task.task_type)"
                          class="text-xs px-2 py-1 bg-orange-500 hover:bg-orange-600 text-white rounded">
                    é€‰æ‹©æ–‡ä»¶
                  </button>
                  <button x-show="task.isPaused || task.status === 'failed' || task.status === 'partial_failed'" 
                        @click="resumeTask(task)"
                        class="text-xs px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded">
                    æ¢å¤
                  </button>
                  <button x-show="task.isUploading" 
                          @click="pauseTask(task)"
                          class="text-xs px-2 py-1 bg-yellow-500 hover:bg-yellow-600 text-white rounded">
                    æš‚åœ
                  </button>
                  <button x-show="task.isUploading || task.isPaused" 
                          @click="cancelTask(task)"
                          class="text-xs px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded">
                    å–æ¶ˆ
                  </button>
                  <button @click="deleteTask(task.task_id || task.file_id)"
                          class="text-xs px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded">
                    åˆ é™¤
                  </button>
                  <button @click="showTaskDetail(task)"
                          class="text-xs px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded">
                    è¯¦æƒ…
                  </button>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- æ“ä½œæ—¥å¿— -->
        <div class="card p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“ æ“ä½œæ—¥å¿—</h3>
          <div class="bg-gray-100 rounded p-3 max-h-48 overflow-y-auto font-mono text-xs">
            <template x-for="log in (logs || []).slice(-30)" :key="log.id">
              <div class="mb-1">
                <span class="text-gray-500" x-text="log.timestamp"></span>
                <span :class="getLogClass(log.level)" x-text="log.message"></span>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- ä¾§è¾¹æ  -->
      <div class="space-y-4">
        
        <!-- ç³»ç»Ÿç›‘æ§ -->
        <div class="card p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“ˆ ç³»ç»Ÿç›‘æ§</h3>
          
          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="text-center p-2 bg-blue-50 rounded border border-blue-200">
              <div class="text-lg font-bold text-gray-800" x-text="taskStats.total"></div>
              <div class="text-gray-600 text-xs">æ€»ä»»åŠ¡</div>
            </div>
            <div class="text-center p-2 bg-green-50 rounded border border-green-200">
              <div class="text-lg font-bold text-gray-800" x-text="taskStats.successRate + '%'"></div>
              <div class="text-gray-600 text-xs">æˆåŠŸç‡</div>
            </div>
            <div class="text-center p-2 bg-purple-50 rounded border border-purple-200">
              <div class="text-lg font-bold text-gray-800" x-text="systemInfo.diskUsage + '%'"></div>
              <div class="text-gray-600 text-xs">ç£ç›˜ä½¿ç”¨</div>
            </div>
            <div class="text-center p-2 bg-orange-50 rounded border border-orange-200">
              <div class="text-lg font-bold text-gray-800" x-text="metrics.goroutines"></div>
              <div class="text-gray-600 text-xs">åç¨‹æ•°</div>
            </div>
          </div>
          
          <button @click="showSystemInfo()" 
                  class="w-full px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded text-sm transition-colors duration-200">
            ğŸ–¥ï¸ è¯¦ç»†ä¿¡æ¯
          </button>
        </div>
      </div>
    </div>

    <!-- é€šçŸ¥å®¹å™¨ -->
    <div class="fixed top-4 right-4 z-50 space-y-2">
      <template x-for="notification in (notifications || [])" :key="notification.id">
        <div x-show="notification.show"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="transform translate-x-full opacity-0"
             x-transition:enter-end="transform translate-x-0 opacity-100"
             x-transition:leave="transition ease-in duration-300"
             x-transition:leave-start="transform translate-x-0 opacity-100"
             x-transition:leave-end="transform translate-x-full opacity-0"
             class="px-6 py-4 rounded-lg shadow-lg max-w-sm"
             :class="getNotificationClass(notification.type)">
          <div class="flex items-center">
            <span x-text="getNotificationIcon(notification.type)" class="mr-2"></span>
            <span x-text="notification.message" class="flex-1"></span>
          </div>
        </div>
      </template>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div x-show="showModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto"
         style="display: none;">
      
      <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" @click="closeModal()"></div>
        
        <div class="inline-block w-full max-w-2xl p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-white rounded-lg shadow-xl">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-800" x-text="modalTitle"></h3>
            <button @click="closeModal()" class="text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <div class="text-gray-800" x-html="modalContent"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€çŠ¶æ€ç®¡ç†
    document.addEventListener('alpine:init', () => {
      Alpine.store('auth', {
        isAuthenticated: false,
        
        checkAuth() {
          // ä»Cookieæ£€æŸ¥è®¤è¯çŠ¶æ€
          const cookies = document.cookie.split(';');
          for (const cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'secret_key' && value) {
              this.isAuthenticated = true;
              return;
            }
          }
          this.isAuthenticated = false;
        },
        
        setAuthenticated(status) {
          this.isAuthenticated = status;
        }
      });
    });
    
    // è®¤è¯åº”ç”¨
    function authApp() {
      return {
        secretKey: '',
        isLoading: false,
        errorMessage: '',
        isAuthenticated: false,
        
        init() {
          // æ£€æŸ¥æ˜¯å¦å·²ç»è®¤è¯
          this.checkAuthStatus();
          // åˆå§‹åŒ–å…¨å±€çŠ¶æ€
          Alpine.store('auth').checkAuth();
        },
        
        async checkAuthStatus() {
          try {
            const response = await fetch('/go-uploader/auth/check');
            const data = await response.json();
            
            if (data.success) {
              this.isAuthenticated = true;
              // è§¦å‘å…¨å±€è®¤è¯çŠ¶æ€æ›´æ–°
              Alpine.store('auth').setAuthenticated(true);
            } else {
              this.isAuthenticated = false;
              Alpine.store('auth').setAuthenticated(false);
            }
          } catch (error) {
            console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
            this.isAuthenticated = false;
            Alpine.store('auth').setAuthenticated(false);
          }
        },
        
        async login() {
          if (!this.secretKey.trim()) {
            this.errorMessage = 'è¯·è¾“å…¥è®¿é—®å¯†é’¥';
            return;
          }
          
          this.isLoading = true;
          this.errorMessage = '';
          
          try {
            const response = await fetch('/go-uploader/auth/login', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                secret_key: this.secretKey
              })
            });
            
            const data = await response.json();
            
            if (data.success) {
              this.isAuthenticated = true;
              Alpine.store('auth').setAuthenticated(true);
              this.secretKey = '';
              this.errorMessage = '';
            } else {
              this.errorMessage = data.message || 'ç™»å½•å¤±è´¥';
            }
          } catch (error) {
            console.error('ç™»å½•å¤±è´¥:', error);
            this.errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
          } finally {
            this.isLoading = false;
          }
        },
        
        async logout() {
          try {
            await fetch('/go-uploader/auth/logout', {
              method: 'POST'
            });
          } catch (error) {
            console.error('ç™»å‡ºå¤±è´¥:', error);
          }
          
          this.isAuthenticated = false;
          Alpine.store('auth').setAuthenticated(false);
          this.secretKey = '';
          this.errorMessage = '';
        }
      };
    }
    
    // æ–‡ä»¶ä¸Šä¼ åº”ç”¨
    function fileUploadApp() {
      return {        
        // é…ç½®
        config: {
          chunkSize: 10,
          concurrent: 3,
          enableMD5: 'true',
          retryCount: 3
        },
        
        // æœåŠ¡å™¨ä»»åŠ¡
        serverTasks: [],
        recoveryPaths: {}, // æ·»åŠ è·¯å¾„è®°å¿†å­˜å‚¨
        taskFilter: 'all', // ä»»åŠ¡ç­›é€‰æ¡ä»¶
        
        // è¿›åº¦å’Œç»Ÿè®¡
        progress: {
          completed: 0,
          failed: 0,
          total: 0,
          percentage: 0,
          totalSize: 0,
          uploadedSize: 0
        },
        
        // ç³»ç»Ÿç›‘æ§
        systemHealth: 'checking',
        metrics: {
          activeTasks: 0,
          memoryUsage: 0,
          goroutines: 0
        },
        taskStats: {
          total: 0,
          successRate: 0
        },
        systemInfo: {
          diskUsage: 0
        },
        
        // UIçŠ¶æ€
        logs: [],
        notifications: [],
        showModal: false,
        modalTitle: '',
        modalContent: '',
        
        // æ€§èƒ½ç›‘æ§
        uploadSpeed: 0,
        lastUploadedBytes: 0,
        lastSpeedUpdate: Date.now(),
        
        // åˆå§‹åŒ–
        init() {
          this.taskFiles = {}; // å•æ–‡ä»¶ä»»åŠ¡çš„æ–‡ä»¶æ˜ å°„
          this.folderFiles = {}; // æ–‡ä»¶å¤¹ä»»åŠ¡çš„æ–‡ä»¶æ˜ å°„
          
          this.log('ç³»ç»Ÿåˆå§‹åŒ–ä¸­...', 'info');
          this.checkSystemHealth();
          this.refreshServerTasks().then(() => {
            // åœ¨ä»»åŠ¡åˆ—è¡¨åˆ·æ–°å®Œæˆåï¼Œè‡ªåŠ¨æ¢å¤ä¸Šä¼ 
            this.autoStartUploadIfNeeded();
          });
          this.updateSystemStatus();
          
          // åŠ è½½è®°å¿†çš„æ–‡ä»¶è·¯å¾„
          this.loadRecoveryPaths();
          
          // å®šæ—¶ä»»åŠ¡
          setInterval(() => this.updateSystemStatus(), 5000);
          setInterval(() => this.checkSystemHealth(), 30000);
          setInterval(() => this.updateUploadSpeed(), 1000);
          setInterval(() => this.refreshServerTasks(), 10000); // å®šæœŸåˆ·æ–°ä»»åŠ¡çŠ¶æ€
        },
        
        // è·å–è®¤è¯å¤´
        getAuthHeaders() {
          const headers = {
            'Content-Type': 'application/json',
          };
          
          // ä»Cookieä¸­è·å–å¯†é’¥
          const cookies = document.cookie.split(';');
          for (const cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'secret_key') {
              headers['X-Secret-Key'] = value;
              break;
            }
          }
          
          return headers;
        },
        
        // ç™»å‡ºåŠŸèƒ½
        async logout() {
          try {
            await fetch('/go-uploader/auth/logout', {
              method: 'POST',
              headers: this.getAuthHeaders()
            });
          } catch (error) {
            console.error('ç™»å‡ºå¤±è´¥:', error);
          }
          
          // é‡å®šå‘åˆ°ç™»å½•é¡µé¢
          window.location.reload();
        },
        
        // ä»»åŠ¡ç®¡ç†
        async refreshServerTasks() {
          try {
            const response = await fetch('/go-uploader/tasks', {
              headers: this.getAuthHeaders()
            });
            const data = await response.json();
            this.serverTasks = data.tasks || [];
            
            // åˆå§‹åŒ–ä»»åŠ¡çš„æœ¬åœ°çŠ¶æ€
            this.serverTasks.forEach(task => {
              if (task.isUploading === undefined) {
                task.isUploading = false;
                task.isPaused = false;
                task.cancelFlag = false;
              }
              
              // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€çš„åˆç†æ€§
              this.validateTaskStatus(task);
            });
            
            this.updateTaskStats();
            this.log('åˆ·æ–°ä»»åŠ¡åˆ—è¡¨: å…± ' + this.serverTasks.length + ' ä¸ªä»»åŠ¡', 'info');
          } catch (error) {
            this.log('è·å–æœåŠ¡å™¨ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
          }
        },
        
        updateTaskStats() {
          this.taskStats.total = this.serverTasks.length;
          const completed = this.serverTasks.filter(t => t.status === 'completed').length;
          this.taskStats.successRate = this.taskStats.total > 0 ? ((completed / this.taskStats.total) * 100).toFixed(1) : 0;
        },
        
        // ä»»åŠ¡ç­›é€‰åŠŸèƒ½
        getFilteredTasks() {
          if (this.taskFilter === 'all') {
            return this.serverTasks || [];
          }
          return (this.serverTasks || []).filter(task => {
            if (this.taskFilter === 'failed') {
              return task.status === 'failed' || task.status === 'error';
            }
            return task.status === this.taskFilter;
          });
        },
        
        getFilteredTasksInfo() {
          const filteredTasks = this.getFilteredTasks();
          const totalTasks = this.serverTasks ? this.serverTasks.length : 0;
          
          if (this.taskFilter === 'all') {
            return `å…± ${totalTasks} ä¸ªä»»åŠ¡`;
          } else {
            return `æ˜¾ç¤º ${filteredTasks.length} / ${totalTasks} ä¸ªä»»åŠ¡`;
          }
        },
        
        filterTasks() {
          // ç­›é€‰é€»è¾‘åœ¨ getFilteredTasks ä¸­å¤„ç†ï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„å¤„ç†
          this.log(`ç­›é€‰ä»»åŠ¡: ${this.taskFilter}`, 'info');
        },
        
        // è·å–å¤±è´¥ä»»åŠ¡æ•°é‡
        getFailedTasksCount() {
          if (!this.serverTasks) return 0;
          return this.serverTasks.filter(task => 
            task.status === 'failed' || task.status === 'error' || task.status === 'partial_failed'
          ).length;
        },
        
        // è·å–å¤±è´¥ä»»åŠ¡æé†’æ¶ˆæ¯
        getFailedTasksMessage() {
          const count = this.getFailedTasksCount();
          if (count === 0) return '';
          
          const partialFailedCount = this.serverTasks.filter(task => task.status === 'partial_failed').length;
          const fullFailedCount = count - partialFailedCount;
          
          let message = `å‘ç° ${count} ä¸ªå¤±è´¥ä»»åŠ¡`;
          if (partialFailedCount > 0 && fullFailedCount > 0) {
            message += ` (${fullFailedCount} ä¸ªå®Œå…¨å¤±è´¥ï¼Œ${partialFailedCount} ä¸ªéƒ¨åˆ†å¤±è´¥)`;
          } else if (partialFailedCount > 0) {
            message += ` (${partialFailedCount} ä¸ªéƒ¨åˆ†å¤±è´¥)`;
          }
          
          return message;
        },
        
        // éªŒè¯å’Œä¿®æ­£ä»»åŠ¡çŠ¶æ€
        validateTaskStatus(task) {
          const hasFiles = this.hasFileForTask(task);
          
          // å¦‚æœä»»åŠ¡çŠ¶æ€æ˜¯ä¸Šä¼ ä¸­ï¼Œä½†ç¼ºå°‘æ–‡ä»¶å¯¹è±¡ï¼Œåº”è¯¥ä¿®æ­£çŠ¶æ€
          if (task.status === 'uploading' && !hasFiles) {
            task.status = 'waiting_files'; // ä¿®æ­£ä¸ºç­‰å¾…æ–‡ä»¶çŠ¶æ€
            task.isUploading = false;
            this.log('ä¿®æ­£ä»»åŠ¡çŠ¶æ€: ' + (task.folder_name || task.filename) + ' (ç¼ºå°‘æ–‡ä»¶å¯¹è±¡ï¼Œä»"ä¸Šä¼ ä¸­"ä¿®æ­£ä¸º"ç­‰å¾…æ–‡ä»¶")', 'warning');
          }
          
          // å¦‚æœä»»åŠ¡æ­£åœ¨æœ¬åœ°ä¸Šä¼ ï¼Œä½†æ²¡æœ‰æ–‡ä»¶å¯¹è±¡ï¼Œåº”è¯¥åœæ­¢
          if (task.isUploading && !hasFiles) {
            task.isUploading = false;
            task.status = 'waiting_files';
            this.log('åœæ­¢æ— æ•ˆä¸Šä¼ : ' + (task.folder_name || task.filename) + ' (ç¼ºå°‘æ–‡ä»¶å¯¹è±¡)', 'warning');
          }
          
          // å¦‚æœä»»åŠ¡çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œä½†ç¼ºå°‘æ–‡ä»¶å¯¹è±¡ï¼Œä¿®æ­£ä¸ºç­‰å¾…æ–‡ä»¶
          if (task.status === 'pending' && !hasFiles && task.completion_rate > 0) {
            task.status = 'waiting_files';
          }
          
          // å¦‚æœä»»åŠ¡æœ‰æ–‡ä»¶å¯¹è±¡ï¼Œä¸”çŠ¶æ€æ˜¯ç­‰å¾…æ–‡ä»¶ï¼Œä¿®æ­£ä¸ºç­‰å¾…
          if (task.status === 'waiting_files' && hasFiles) {
            task.status = 'pending';
          }
        },

        // æ–‡ä»¶è·¯å¾„è®°å¿†åŠŸèƒ½
        loadRecoveryPaths() {
          try {
            const savedPaths = localStorage.getItem('recoveryPaths');
            if (savedPaths) {
              this.recoveryPaths = JSON.parse(savedPaths);
              this.log('å·²åŠ è½½æ¢å¤è·¯å¾„è®°å¿†', 'info');
            }
          } catch (error) {
            console.error('åŠ è½½æ¢å¤è·¯å¾„å¤±è´¥:', error);
            this.recoveryPaths = {};
          }
        },
        
        // ä¿å­˜æ–‡ä»¶è·¯å¾„åˆ°æœ¬åœ°å­˜å‚¨
        saveRecoveryPath(taskId, filePath, fileSize) {
          this.recoveryPaths[taskId] = {
            path: filePath,
            size: fileSize,
            timestamp: Date.now()
          };
          try {
            // æ¸…ç†è¶…è¿‡90å¤©çš„è®°å½•
            const now = Date.now();
            const oneWeek = 90 * 24 * 60 * 60 * 1000;
            
            Object.keys(this.recoveryPaths).forEach(key => {
              if (now - this.recoveryPaths[key].timestamp > oneWeek) {
                delete this.recoveryPaths[key];
              }
            });
            
            localStorage.setItem('recoveryPaths', JSON.stringify(this.recoveryPaths));
          } catch (error) {
            console.error('ä¿å­˜æ¢å¤è·¯å¾„å¤±è´¥:', error);
          }
        },
        
        // ç»Ÿä¸€æ–‡ä»¶é€‰æ‹©å¤„ç†
        selectFiles() {
          this.$refs.fileInput.click();
        },
        
        selectFolder() {
          this.$refs.folderInput.click();
        },
        
        selectRecoveryTask(taskId, taskType) {
          // æŸ¥æ‰¾ä»»åŠ¡ä¿¡æ¯
          const task = this.serverTasks.find(t => (t.task_id || t.file_id) === taskId);
          if (!task) {
            this.showNotification('æœªæ‰¾åˆ°å¯¹åº”çš„ä»»åŠ¡', 'error');
            return;
          }
          
          // è®¾ç½®å½“å‰æ¢å¤ä»»åŠ¡IDå’Œç±»å‹
          window.currentRecoveryTask = taskId;
          window.currentRecoveryTaskType = taskType;
          
          // æ ¹æ®ä»»åŠ¡ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤ºå’Œæ“ä½œ
          if (taskType === 'folder') {
            this.showNotification('ğŸ’¡ è¯·é€‰æ‹©ä¸ä»»åŠ¡ "' + task.folder_name + '" å¯¹åº”çš„æ–‡ä»¶å¤¹', 'info', 5000);
            this.log('ğŸ”„ å‡†å¤‡æ¢å¤æ–‡ä»¶å¤¹ä»»åŠ¡: ' + task.folder_name, 'info');
            this.$refs.folderInput.click();
          } else {
            this.showNotification('ğŸ’¡ è¯·é€‰æ‹©ä¸ä»»åŠ¡ "' + task.filename + '" å¯¹åº”çš„æ–‡ä»¶', 'info', 5000);
            this.log('ğŸ”„ å‡†å¤‡æ¢å¤æ–‡ä»¶ä»»åŠ¡: ' + task.filename, 'info');
            this.$refs.fileInput.click();
          }
        },
        
        // æ–‡ä»¶é€‰æ‹©å¤„ç†å‡½æ•°
        handleFileSelect(event) {
          const files = Array.from(event.target.files);
          if (files.length === 0) return;
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯æ¢å¤ç‰¹å®šä»»åŠ¡
          if (window.currentRecoveryTask) {
            this.handleRecoveryFileSelect(files, window.currentRecoveryTask);
            window.currentRecoveryTask = null; // æ¸…é™¤å½“å‰æ¢å¤ä»»åŠ¡
            event.target.value = '';
            return;
          }
          
          // å¤„ç†ç‹¬ç«‹æ–‡ä»¶
          this.processIndividualFiles(files);
          
          // æ¸…ç©ºè¾“å…¥æ¡†ä»¥å…è®¸é‡å¤é€‰æ‹©ç›¸åŒæ–‡ä»¶
          event.target.value = '';
          
          // åˆ·æ–°æœåŠ¡å™¨ä»»åŠ¡å¹¶è‡ªåŠ¨å¼€å§‹ä¸Šä¼ 
          this.refreshServerTasks().then(() => {
            this.autoStartUploadIfNeeded();
          });
        },
        
        // æ–‡ä»¶å¤¹é€‰æ‹©å¤„ç†å‡½æ•°
        handleFolderSelect(event) {
          const files = Array.from(event.target.files);
          if (files.length === 0) return;
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯æ¢å¤ç‰¹å®šä»»åŠ¡
          if (window.currentRecoveryTask) {
            this.handleRecoveryFileSelect(files, window.currentRecoveryTask);
            window.currentRecoveryTask = null; // æ¸…é™¤å½“å‰æ¢å¤ä»»åŠ¡
            event.target.value = '';
            return;
          }
          
          // åˆ†æé€‰æ‹©çš„æ–‡ä»¶ï¼Œåˆ¤æ–­æ˜¯æ–‡ä»¶å¤¹è¿˜æ˜¯ç‹¬ç«‹æ–‡ä»¶
          const fileGroups = this.analyzeFileSelection(files);
          
          this.log('ğŸ“ æ–‡ä»¶å¤¹é€‰æ‹©åˆ†æç»“æœ:', 'info');
          this.log('- æ–‡ä»¶å¤¹æ•°é‡: ' + fileGroups.folders.length, 'info');
          this.log('- ç‹¬ç«‹æ–‡ä»¶æ•°é‡: ' + fileGroups.individualFiles.length, 'info');
          
          // å¤„ç†æ–‡ä»¶å¤¹
          for (const folderGroup of fileGroups.folders) {
            this.processFolderSelection(folderGroup);
          }
          
          // å¤„ç†ç‹¬ç«‹æ–‡ä»¶
          if (fileGroups.individualFiles.length > 0) {
            this.processIndividualFiles(fileGroups.individualFiles);
          }
          
          // æ¸…ç©ºè¾“å…¥æ¡†ä»¥å…è®¸é‡å¤é€‰æ‹©ç›¸åŒæ–‡ä»¶
          event.target.value = '';
          
          // åˆ·æ–°æœåŠ¡å™¨ä»»åŠ¡å¹¶è‡ªåŠ¨å¼€å§‹ä¸Šä¼ 
          this.refreshServerTasks().then(() => {
            this.autoStartUploadIfNeeded();
          });
        },
        
        // åˆ†ææ–‡ä»¶é€‰æ‹©ï¼Œå°†æ–‡ä»¶åˆ†ç»„ä¸ºæ–‡ä»¶å¤¹å’Œç‹¬ç«‹æ–‡ä»¶
        analyzeFileSelection(files) {
          const folders = new Map(); // æ–‡ä»¶å¤¹ç»„
          const individualFiles = []; // ç‹¬ç«‹æ–‡ä»¶
          
          for (const file of files) {
            if (file.webkitRelativePath) {
              // è¿™æ˜¯æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶
              const folderName = file.webkitRelativePath.split('/')[0];
              if (!folders.has(folderName)) {
                folders.set(folderName, []);
              }
              folders.get(folderName).push(file);
            } else {
              // è¿™æ˜¯ç‹¬ç«‹é€‰æ‹©çš„æ–‡ä»¶
              individualFiles.push(file);
            }
          }
          
          return {
            folders: Array.from(folders.values()),
            individualFiles: individualFiles
          };
        },
        
        // å¤„ç†æ–‡ä»¶å¤¹é€‰æ‹©
        async processFolderSelection(folderFiles) {
          if (folderFiles.length === 0) return;
          
          const folderName = folderFiles[0].webkitRelativePath.split('/')[0];
          const totalSize = folderFiles.reduce((sum, f) => sum + f.size, 0);
          
          this.log('ğŸ“ å¤„ç†æ–‡ä»¶å¤¹: ' + folderName + ' (' + folderFiles.length + ' ä¸ªæ–‡ä»¶)', 'info');
          
          // æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…çš„æ–‡ä»¶å¤¹ä»»åŠ¡
          const matchedTask = this.serverTasks.find(task => 
            task.task_type === 'folder' && 
            task.folder_name === folderName && 
            Math.abs(task.file_size - totalSize) / task.file_size < 0.1 // å…è®¸10%çš„å¤§å°è¯¯å·®
          );
          
          if (matchedTask) {
            // è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦æ¢å¤
            const shouldRecover = confirm(
              'æ‰¾åˆ°åŒ¹é…çš„æœªå®Œæˆæ–‡ä»¶å¤¹ä»»åŠ¡ "' + folderName + '"ï¼Œæ˜¯å¦è¦æ¢å¤ä¸Šä¼ ï¼Ÿ\n' +
              'å·²å®Œæˆ: ' + (matchedTask.completion_rate || 0) + '%'
            );
            
            if (shouldRecover) {
              // æ¢å¤æ–‡ä»¶å¤¹ä»»åŠ¡
              this.createRecoveryFolderTask(matchedTask, folderFiles);
              return;
            }
          }
          
          // åˆ›å»ºæ–°çš„æ–‡ä»¶å¤¹ä»»åŠ¡
          this.createFolderTask(folderName, folderFiles);
        },
        
        // å¤„ç†ç‹¬ç«‹æ–‡ä»¶é€‰æ‹©
        async processIndividualFiles(files) {
          if (files.length === 0) return;
          
          this.log('ğŸ“„ å¤„ç†ç‹¬ç«‹æ–‡ä»¶: ' + files.length + ' ä¸ªæ–‡ä»¶', 'info');
          
          // åˆ›å»ºå•æ–‡ä»¶ä»»åŠ¡
          for (const file of files) {
            await this.createSingleFileTask(file);
          }
          
          this.showNotification('å·²æ·»åŠ  ' + files.length + ' ä¸ªæ–‡ä»¶ä»»åŠ¡', 'success');
          
          // åˆ·æ–°æœåŠ¡å™¨ä»»åŠ¡åˆ—è¡¨
          await this.refreshServerTasks();
          
          // è‡ªåŠ¨å¼€å§‹ä¸Šä¼ 
          this.autoStartUploadIfNeeded();
        },
        
        // åˆ›å»ºå•æ–‡ä»¶ä»»åŠ¡
        async createSingleFileTask(file) {
          try {
            const chunkSize = this.config.chunkSize * 1024 * 1024;
            const totalChunks = Math.ceil(file.size / chunkSize);
            
            // ç”Ÿæˆæ–‡ä»¶ID
            const fileId = 'file_' + file.name + '_' + file.size + '_' + Date.now();
            
            // å‡†å¤‡è¡¨å•æ•°æ®åˆ›å»ºä»»åŠ¡ï¼ˆé€šè¿‡ä¸Šä¼ ç¬¬ä¸€ä¸ªåˆ†ç‰‡æ¥åˆ›å»ºä»»åŠ¡ï¼‰
            const firstChunk = file.slice(0, Math.min(chunkSize, file.size));
            
            const formData = new FormData();
            formData.append('file_id', fileId);
            formData.append('chunk_index', '0');
            formData.append('chunk', firstChunk);
            formData.append('relative_path', file.name);
            formData.append('total_chunks', totalChunks.toString());
            formData.append('file_size', file.size.toString());
            
            // è®¡ç®—MD5ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if (this.config.enableMD5 === 'true') {
              const md5 = await this.calculateMD5(firstChunk);
              formData.append('md5', md5);
            }
            
            // ä¸Šä¼ ç¬¬ä¸€ä¸ªåˆ†ç‰‡æ¥åˆ›å»ºä»»åŠ¡
            const response = await this.fetchWithRetry('/go-uploader/upload_chunk', {
              method: 'POST',
              body: formData
            });
            
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(errorData.error || 'åˆ›å»ºä»»åŠ¡å¤±è´¥: ' + response.status);
            }
            
            this.log('ğŸ“„ å•æ–‡ä»¶ä»»åŠ¡åˆ›å»ºæˆåŠŸ: ' + file.name, 'success');
            
            // ä¿å­˜æ–‡ä»¶å¯¹è±¡ä»¥ä¾¿åç»­ä¸Šä¼ 
            this.saveFileForTask(fileId, file);
            
          } catch (error) {
            this.log('âŒ åˆ›å»ºå•æ–‡ä»¶ä»»åŠ¡å¤±è´¥: ' + file.name + ' - ' + error.message, 'error');
            this.showNotification('åˆ›å»ºæ–‡ä»¶ä»»åŠ¡å¤±è´¥: ' + file.name, 'error');
          }
        },
        
        // ä¿å­˜æ–‡ä»¶å¯¹è±¡ä»¥ä¾¿åç»­ä¸Šä¼ 
        saveFileForTask(fileId, file) {
          if (!this.taskFiles) {
            this.taskFiles = {};
          }
          this.taskFiles[fileId] = file;
        },
        
        // æ ¹æ®æ–‡ä»¶å¤¹ä»»åŠ¡IDå’Œç›¸å¯¹è·¯å¾„ä¿å­˜æ–‡ä»¶å¯¹è±¡
        saveFileForTaskByPath(folderTaskId, relativePath, file) {
          if (!this.folderFiles) {
            this.folderFiles = {};
          }
          if (!this.folderFiles[folderTaskId]) {
            this.folderFiles[folderTaskId] = {};
          }
          this.folderFiles[folderTaskId][relativePath] = file;
        },
        
        // æ ¹æ®æ–‡ä»¶å¤¹ä»»åŠ¡IDå’Œç›¸å¯¹è·¯å¾„è·å–æ–‡ä»¶å¯¹è±¡
        getFileForTaskByPath(folderTaskId, relativePath) {
          if (!this.folderFiles || !this.folderFiles[folderTaskId]) {
            return null;
          }
          return this.folderFiles[folderTaskId][relativePath] || null;
        },
        
        // è·å–ä»»åŠ¡å¯¹åº”çš„æ–‡ä»¶å¯¹è±¡
        getFileForTask(fileId) {
          if (!this.taskFiles) {
            return null;
          }
          return this.taskFiles[fileId] || null;
        },
        
        // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦æœ‰å¯¹åº”çš„æ–‡ä»¶å¯¹è±¡ï¼ˆç”¨äºUIæ˜¾ç¤ºï¼‰
        hasFileForTask(task) {
          const taskId = task.task_id || task.file_id;
          
          if (task.task_type === 'folder') {
            // æ£€æŸ¥æ–‡ä»¶å¤¹ä»»åŠ¡æ˜¯å¦æœ‰æ–‡ä»¶å¯¹è±¡
            return this.folderFiles && this.folderFiles[taskId] && Object.keys(this.folderFiles[taskId]).length > 0;
          } else {
            // æ£€æŸ¥å•æ–‡ä»¶ä»»åŠ¡æ˜¯å¦æœ‰æ–‡ä»¶å¯¹è±¡
            return this.getFileForTask(taskId) !== null;
          }
        },
        
        // å¤„ç†æ¢å¤ç‰¹å®šä»»åŠ¡çš„æ–‡ä»¶é€‰æ‹©
        handleRecoveryFileSelect(files, taskId) {
          // æŸ¥æ‰¾å¯¹åº”çš„ä»»åŠ¡
          const task = this.serverTasks.find(t => (t.task_id || t.file_id) === taskId);
          if (!task) {
            this.showNotification('æœªæ‰¾åˆ°å¯¹åº”çš„ä»»åŠ¡ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            return;
          }
          
          // ä½¿ç”¨å…¨å±€ä»»åŠ¡ç±»å‹ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä»ä»»åŠ¡ä¸­è·å–
          const taskType = window.currentRecoveryTaskType || task.task_type;
          
          if (taskType === 'folder') {
            // æ–‡ä»¶å¤¹ä»»åŠ¡æ¢å¤
            const folderName = files[0].webkitRelativePath.split('/')[0];
            this.log('æ¢å¤æ–‡ä»¶å¤¹ä»»åŠ¡: ' + task.folder_name + ' -> ' + folderName, 'info');
            
            // ä¿å­˜è·¯å¾„è®°å¿†
            this.saveRecoveryPath(taskId, folderName, task.file_size);
            
            // åˆ›å»ºæ¢å¤çš„æ–‡ä»¶å¤¹ä»»åŠ¡
            this.createRecoveryFolderTask(task, files);
          } else {
            // å•æ–‡ä»¶ä»»åŠ¡æ¢å¤
            const file = files[0];
            this.log('æ¢å¤æ–‡ä»¶ä»»åŠ¡: ' + task.filename + ' -> ' + file.name, 'info');
            
            // ä¿å­˜è·¯å¾„è®°å¿†
            this.saveRecoveryPath(taskId, file.name, file.size);
            
            // åˆ›å»ºæ¢å¤çš„æ–‡ä»¶ä»»åŠ¡
            this.createRecoveryFileTask(task, file);
          }
          
          // æ¸…é™¤å…¨å±€å˜é‡
          window.currentRecoveryTask = null;
          window.currentRecoveryTaskType = null;
          
          // ç«‹å³å¼€å§‹æ¢å¤çš„ä»»åŠ¡ä¸Šä¼ 
          setTimeout(() => {
            const recoveredTask = this.serverTasks.find(t => (t.task_id || t.file_id) === taskId);
            if (recoveredTask) {
              // éªŒè¯å’Œä¿®æ­£ä»»åŠ¡çŠ¶æ€
              this.validateTaskStatus(recoveredTask);
              
              if (this.hasFileForTask(recoveredTask)) {
                this.startUpload(recoveredTask);
              }
            }
          }, 500);
        },
        
        // åŒ¹é…æ–‡ä»¶ä¸æœªå®Œæˆä»»åŠ¡
        matchFilesWithTasks(files) {
          const matched = [];
          const unmatched = [];
          
          // å¦‚æœæ²¡æœ‰æœåŠ¡å™¨ä»»åŠ¡ï¼Œå…¨éƒ¨è§†ä¸ºæœªåŒ¹é…
          if (!this.serverTasks || this.serverTasks.length === 0) {
            return { matched: [], unmatched: files };
          }
          
          // åŒ¹é…æ–‡ä»¶å’Œä»»åŠ¡
          for (const file of files) {
            const fileName = file.name;
            const fileSize = file.size;
            
            // æŸ¥æ‰¾åŒ¹é…çš„ä»»åŠ¡
            const matchedTask = this.serverTasks.find(task => {
              // å¯¹äºå•æ–‡ä»¶ä»»åŠ¡ï¼ŒåŒ¹é…æ–‡ä»¶åå’Œå¤§å°
              if (task.task_type !== 'folder') {
                return (
                  (task.filename === fileName || task.relative_path === fileName) && 
                  Math.abs(task.file_size - fileSize) < 100 // å…è®¸100å­—èŠ‚çš„è¯¯å·®
                );
              }
              return false;
            });
            
            if (matchedTask) {
              matched.push({
                file: file,
                task: matchedTask
              });
            } else {
              unmatched.push(file);
            }
          }
          
          return { matched, unmatched };
        },
        
        // æ¢å¤åŒ¹é…çš„æ–‡ä»¶
        recoverMatchedFiles(matchedFiles) {
          for (const match of matchedFiles) {
            const file = match.file;
            const task = match.task;
            
            if (task.task_type !== 'folder') {
              // å•æ–‡ä»¶ä»»åŠ¡æ¢å¤
              this.createRecoveryFileTask(task, file);
            }
          }
          
          this.showNotification('å·²æ¢å¤ ' + matchedFiles.length + ' ä¸ªåŒ¹é…çš„ä»»åŠ¡', 'success');
          // è‡ªåŠ¨å¼€å§‹ä¸Šä¼ 
          this.autoStartUploadIfNeeded();
        },
        
        // åˆ›å»ºæ¢å¤çš„æ–‡ä»¶ä»»åŠ¡
        createRecoveryFileTask(task, file) {
          // ä¿å­˜æ–‡ä»¶å¯¹è±¡ä»¥ä¾¿ä¸Šä¼ 
          this.saveFileForTask(task.task_id || task.file_id, file);
          
          this.log('æˆåŠŸæ¢å¤æ–‡ä»¶ä»»åŠ¡: ' + file.name + ' (' + (task.completion_rate || 0) + '%)', 'success');
          this.showNotification('å·²æ¢å¤æ–‡ä»¶ä»»åŠ¡: ' + file.name, 'success');
          
          // ä¿å­˜è·¯å¾„è®°å¿†
          this.saveRecoveryPath(task.task_id || task.file_id, file.name, file.size);
          
          // ç«‹å³å¼€å§‹è¿™ä¸ªæ¢å¤çš„ä»»åŠ¡
          setTimeout(() => {
            this.startUpload(task);
          }, 500);
        },
        
        // åˆ›å»ºæ¢å¤çš„æ–‡ä»¶å¤¹ä»»åŠ¡
        async createRecoveryFolderTask(task, files) {
          try {
            // è·å–ä»»åŠ¡è¯¦æƒ…
            const response = await fetch('/go-uploader/tasks/' + task.task_id, {
              headers: this.getAuthHeaders()
            });
            const taskDetail = await response.json();
            
            if (!taskDetail.sub_tasks || taskDetail.sub_tasks.length === 0) {
              throw new Error('æ–‡ä»¶å¤¹ä»»åŠ¡æ²¡æœ‰å­ä»»åŠ¡ä¿¡æ¯');
            }
            
            // ä¿å­˜æ–‡ä»¶å¯¹è±¡æ˜ å°„ - ä½¿ç”¨ç›¸å¯¹è·¯å¾„ä½œä¸ºé”®
            for (const file of files) {
              const relativePath = file.webkitRelativePath;
              this.saveFileForTaskByPath(task.task_id, relativePath, file);
              this.log('æ¢å¤æ–‡ä»¶æ˜ å°„: ' + relativePath + ' -> ' + file.name, 'info');
            }
            
            this.log('æˆåŠŸæ¢å¤æ–‡ä»¶å¤¹ä»»åŠ¡: ' + taskDetail.folder_name + ' (' + (taskDetail.completion_rate || 0) + '%)', 'success');
            this.showNotification('å·²æ¢å¤æ–‡ä»¶å¤¹ä»»åŠ¡: ' + taskDetail.folder_name, 'success');
            
            // ä¿å­˜è·¯å¾„è®°å¿†
            this.saveRecoveryPath(task.task_id, taskDetail.folder_name, taskDetail.file_size);
            
            // ç«‹å³å¼€å§‹è¿™ä¸ªæ¢å¤çš„æ–‡ä»¶å¤¹ä»»åŠ¡
            setTimeout(() => {
              this.startUpload(task);
            }, 500);
            
          } catch (error) {
            this.log('æ¢å¤æ–‡ä»¶å¤¹ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
          }
        },
                
        // åˆ›å»ºæ–‡ä»¶å¤¹ä»»åŠ¡
        async createFolderTask(folderName, files) {
          try {
            const chunkSize = this.config.chunkSize * 1024 * 1024;
            
            // å‡†å¤‡æ–‡ä»¶ä¿¡æ¯
            const fileInfos = files.map(file => ({
              name: file.name,
              relative_path: file.webkitRelativePath || file.name,
              size: file.size,
              total_chunks: Math.ceil(file.size / chunkSize)
            }));
            
            // è°ƒç”¨åç«¯APIåˆ›å»ºæ–‡ä»¶å¤¹ä»»åŠ¡
            const response = await this.fetchWithRetry('/go-uploader/folder_tasks', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                folder_name: folderName,
                files: fileInfos
              })
            });
            
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(errorData.error || 'åˆ›å»ºæ–‡ä»¶å¤¹ä»»åŠ¡å¤±è´¥: ' + response.status);
            }
            
            const result = await response.json();
            
            this.log('ğŸ“ æ–‡ä»¶å¤¹ä»»åŠ¡åˆ›å»ºæˆåŠŸ: ' + folderName + ' (' + result.total_files + ' ä¸ªæ–‡ä»¶)', 'success');
            this.showNotification('æ–‡ä»¶å¤¹ä»»åŠ¡åˆ›å»ºæˆåŠŸ: ' + folderName, 'success');
            
            // ä¿å­˜æ–‡ä»¶å¯¹è±¡æ˜ å°„ - ä½¿ç”¨ç›¸å¯¹è·¯å¾„ä½œä¸ºé”®
            for (const file of files) {
              const relativePath = file.webkitRelativePath || file.name;
              this.saveFileForTaskByPath(result.folder_task_id, relativePath, file);
              this.log('ä¿å­˜æ–‡ä»¶æ˜ å°„: ' + relativePath + ' -> ' + file.name, 'info');
            }
            
            // åˆ·æ–°æœåŠ¡å™¨ä»»åŠ¡åˆ—è¡¨
            await this.refreshServerTasks();
            
          } catch (error) {
              this.log('âŒ åˆ›å»ºæ–‡ä»¶å¤¹ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
              this.showNotification('åˆ›å»ºæ–‡ä»¶å¤¹ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
          }
        },
        

        
        // è‡ªåŠ¨å¼€å§‹ä¸Šä¼ ï¼ˆå¦‚æœéœ€è¦ï¼‰
        autoStartUploadIfNeeded() {
          // ç­‰å¾…çŸ­æš‚æ—¶é—´ç¡®ä¿ä»»åŠ¡åˆ—è¡¨å·²åˆ·æ–°
          setTimeout(() => {
            const pendingTasks = this.serverTasks.filter(t => 
              (t.status === 'pending' || t.status === 'uploading' || t.status === 'waiting_files') && 
              !t.isUploading && 
              !t.isPaused
            );
            
            if (pendingTasks.length === 0) {
              this.log('æ²¡æœ‰å‘ç°å¾…ä¸Šä¼ ä»»åŠ¡', 'info');
              return;
            }
            
            // æ£€æŸ¥å“ªäº›ä»»åŠ¡æœ‰æ–‡ä»¶å¯¹è±¡ï¼Œå“ªäº›æ²¡æœ‰
            const tasksWithFiles = [];
            const tasksWithoutFiles = [];
            
            pendingTasks.forEach(task => {
              // å…ˆéªŒè¯å’Œä¿®æ­£ä»»åŠ¡çŠ¶æ€
              this.validateTaskStatus(task);
              
              const taskId = task.task_id || task.file_id;
              let hasFile = false;
              
              if (task.task_type === 'folder') {
                // æ£€æŸ¥æ–‡ä»¶å¤¹ä»»åŠ¡æ˜¯å¦æœ‰æ–‡ä»¶å¯¹è±¡
                hasFile = this.folderFiles && this.folderFiles[taskId] && Object.keys(this.folderFiles[taskId]).length > 0;
              } else {
                // æ£€æŸ¥å•æ–‡ä»¶ä»»åŠ¡æ˜¯å¦æœ‰æ–‡ä»¶å¯¹è±¡
                hasFile = this.getFileForTask(taskId) !== null;
              }
              
              if (hasFile) {
                tasksWithFiles.push(task);
              } else {
                tasksWithoutFiles.push(task);
              }
            });
            
            this.log('å‘ç° ' + pendingTasks.length + ' ä¸ªå¾…ä¸Šä¼ ä»»åŠ¡', 'info');
            this.log('- æœ‰æ–‡ä»¶å¯¹è±¡: ' + tasksWithFiles.length + ' ä¸ª', 'info');
            this.log('- ç¼ºå°‘æ–‡ä»¶å¯¹è±¡: ' + tasksWithoutFiles.length + ' ä¸ª', 'info');
            
            // å¼€å§‹æœ‰æ–‡ä»¶å¯¹è±¡çš„ä»»åŠ¡
            tasksWithFiles.forEach(task => {
              this.startUpload(task);
            });
            
            // å¯¹äºç¼ºå°‘æ–‡ä»¶å¯¹è±¡çš„ä»»åŠ¡ï¼Œæç¤ºç”¨æˆ·
            if (tasksWithoutFiles.length > 0) {
              this.log('âš ï¸ æœ‰ ' + tasksWithoutFiles.length + ' ä¸ªä»»åŠ¡ç¼ºå°‘æ–‡ä»¶å¯¹è±¡ï¼Œæ— æ³•è‡ªåŠ¨æ¢å¤ä¸Šä¼ ', 'warning');
              this.log('ğŸ’¡ æç¤ºï¼šè¿™äº›ä»»åŠ¡éœ€è¦é‡æ–°é€‰æ‹©æ–‡ä»¶æ‰èƒ½ç»§ç»­ä¸Šä¼ ', 'info');
              
              // æ˜¾ç¤ºç¼ºå°‘æ–‡ä»¶å¯¹è±¡çš„ä»»åŠ¡
              tasksWithoutFiles.forEach(task => {
                this.log('- ' + (task.folder_name || task.filename) + ' (ç¼ºå°‘æ–‡ä»¶å¯¹è±¡)', 'warning');
              });
              
              this.showNotification(
                'å‘ç° ' + tasksWithoutFiles.length + ' ä¸ªä»»åŠ¡ç¼ºå°‘æ–‡ä»¶å¯¹è±¡ï¼Œéœ€è¦é‡æ–°é€‰æ‹©æ–‡ä»¶', 
                'warning', 
                5000
              );
            }
          }, 1000);
        },
        
        // å¼€å§‹ä¸Šä¼ ï¼ˆå•ä»»åŠ¡ï¼‰
        async startUpload(task) {
          if (task.isUploading) {
            this.showNotification('è¯¥ä»»åŠ¡æ­£åœ¨ä¸Šä¼ ä¸­', 'warning');
            return;
          }
          
          // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å¯¹è±¡
          if (!this.hasFileForTask(task)) {
            this.log('âš ï¸ æ— æ³•å¼€å§‹ä¸Šä¼ : ' + (task.folder_name || task.filename) + ' - ç¼ºå°‘æ–‡ä»¶å¯¹è±¡', 'warning');
            this.showNotification('ä»»åŠ¡ "' + (task.folder_name || task.filename) + '" ç¼ºå°‘æ–‡ä»¶å¯¹è±¡ï¼Œè¯·ç‚¹å‡»"é€‰æ‹©æ–‡ä»¶"æŒ‰é’®é‡æ–°é€‰æ‹©', 'warning');
            task.status = 'waiting_files'; // è®¾ç½®ä¸ºç­‰å¾…æ–‡ä»¶çŠ¶æ€
            return;
          }
          
          // è®¾ç½®ä»»åŠ¡çŠ¶æ€
          task.isUploading = true;
          task.cancelFlag = false;
          task.isPaused = false;
          task.status = 'uploading'; // æ˜ç¡®è®¾ç½®ä¸ºä¸Šä¼ ä¸­çŠ¶æ€
          
          // åˆå§‹åŒ–æˆ–é‡ç½®é€Ÿåº¦è®¡ç®—ç›¸å…³å˜é‡
          if (!this.lastSpeedUpdate) {
            this.lastSpeedUpdate = Date.now();
          }
          this.lastUploadedBytes = 0;
          
          this.log('ğŸš€ å¼€å§‹ä¸Šä¼ ä»»åŠ¡: ' + (task.folder_name || task.filename), 'info');
          this.log('ä»»åŠ¡çŠ¶æ€å·²è®¾ç½®ä¸ºä¸Šä¼ ä¸­ï¼Œå¼€å§‹é€Ÿåº¦ç›‘æ§ (lastSpeedUpdate=' + this.lastSpeedUpdate + ')', 'info');
          this.showNotification('å¼€å§‹ä¸Šä¼ ä»»åŠ¡: ' + (task.folder_name || task.filename), 'success');
          
          try {
            if (task.task_type === 'folder') {
              await this.uploadFolderTask(task);
            } else {
              await this.uploadSingleFile(task);
            }
            
            task.status = 'completed';
            task.completion_rate = 100;
            this.log('âœ… å®Œæˆ: ' + (task.folder_name || task.filename), 'success');
            this.showNotification('ä¸Šä¼ å®Œæˆ: ' + (task.folder_name || task.filename), 'success');
            
          } catch (error) {
            task.status = 'error';
            this.log('âŒ å¤±è´¥: ' + (task.folder_name || task.filename) + ' - ' + error.message, 'error');
            this.showNotification('ä¸Šä¼ å¤±è´¥: ' + (task.folder_name || task.filename), 'error');
          } finally {
            task.isUploading = false;
            this.log('ä»»åŠ¡ä¸Šä¼ çŠ¶æ€å·²é‡ç½®ï¼Œåœæ­¢é€Ÿåº¦ç›‘æ§', 'info');
          }
        },
        
        // ä¸Šä¼ æ–‡ä»¶å¤¹ä»»åŠ¡
        async uploadFolderTask(folderItem) {
          // è·å–æ–‡ä»¶å¤¹ä»»åŠ¡è¯¦æƒ…
          const response = await fetch('/go-uploader/tasks/' + folderItem.task_id, {
            headers: this.getAuthHeaders()
          });
          const taskDetail = await response.json();
          
          if (!taskDetail.sub_tasks || taskDetail.sub_tasks.length === 0) {
            throw new Error('æ–‡ä»¶å¤¹ä»»åŠ¡æ²¡æœ‰å­ä»»åŠ¡ä¿¡æ¯');
          }
          
          this.log('ğŸ“ å¼€å§‹ä¸Šä¼ æ–‡ä»¶å¤¹: ' + taskDetail.folder_name + ' (' + taskDetail.sub_tasks.length + ' ä¸ªæ–‡ä»¶)', 'info');
          
          let completedFiles = 0;
          let failedFiles = 0;
          
          // ç»Ÿè®¡å·²å®Œæˆçš„ä»»åŠ¡
          const alreadyCompletedFiles = taskDetail.sub_tasks.filter(st => st.status === 'completed').length;
          completedFiles = alreadyCompletedFiles;
          folderItem.completedFiles = completedFiles;
          
          // éå†æœªå®Œæˆçš„å­ä»»åŠ¡
          const uncompletedTasks = taskDetail.sub_tasks.filter(st => st.status !== 'completed');
          
          // æ£€æŸ¥æ–‡ä»¶å¯¹è±¡æ˜ å°„æƒ…å†µ
          let mappedFiles = 0;
          let unmappedFiles = 0;
          for (const subTask of uncompletedTasks) {
            // ä¼˜å…ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„æŸ¥æ‰¾æ–‡ä»¶å¯¹è±¡
            let file = this.getFileForTaskByPath(folderItem.task_id, subTask.relative_path);
            if (!file) {
              // å›é€€åˆ°ä½¿ç”¨å­ä»»åŠ¡IDæŸ¥æ‰¾
              file = this.getFileForTask(subTask.file_id);
            }
            
            if (file) {
              mappedFiles++;
            } else {
              unmappedFiles++;
            }
          }
          
          this.log('æ–‡ä»¶å¯¹è±¡æ˜ å°„æ£€æŸ¥: å·²æ˜ å°„ ' + mappedFiles + ' ä¸ªï¼Œæœªæ˜ å°„ ' + unmappedFiles + ' ä¸ª', 'info');
          
          if (unmappedFiles > 0) {
            this.log('è­¦å‘Š: æœ‰ ' + unmappedFiles + ' ä¸ªæ–‡ä»¶ç¼ºå°‘æ–‡ä»¶å¯¹è±¡ï¼Œè¿™äº›æ–‡ä»¶å°†è·³è¿‡ä¸Šä¼ ', 'warning');
          }
          
          for (const subTask of uncompletedTasks) {             
            if (folderItem.cancelFlag || folderItem.isPaused) {
              throw new Error('ä¸Šä¼ è¢«ä¸­æ–­');
            }
            
            try {
              // ä¼˜å…ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„æŸ¥æ‰¾æ–‡ä»¶å¯¹è±¡
              let file = this.getFileForTaskByPath(folderItem.task_id, subTask.relative_path);
              if (!file) {
                // å›é€€åˆ°ä½¿ç”¨å­ä»»åŠ¡IDæŸ¥æ‰¾
                file = this.getFileForTask(subTask.file_id);
              }
              
              if (!file) {
                failedFiles++;
                this.log('ğŸ“„ æ–‡ä»¶å¤¹ä¸­è·³è¿‡: ' + subTask.relative_path + ' - æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶å¯¹è±¡ (file_id: ' + subTask.file_id + ')', 'warning');
                continue;
              }
              
              this.log('ğŸ“„ å¼€å§‹ä¸Šä¼ : ' + subTask.relative_path + ' (file_id: ' + subTask.file_id + ')', 'info');
              
              // åˆ›å»ºæ–‡ä»¶é¡¹è¿›è¡Œä¸Šä¼ 
              const fileItem = {
                task_id: subTask.file_id,
                file_id: subTask.file_id,
                filename: subTask.filename,
                relative_path: subTask.relative_path,
                file_size: subTask.file_size,
                status: 'uploading',
                progress: subTask.completion_rate || 0,
                completion_rate: subTask.completion_rate || 0,
                uploadedBytes: Math.round((subTask.completion_rate || 0) / 100 * subTask.file_size)
              };
              
              // ä¸´æ—¶ä¿å­˜æ–‡ä»¶å¯¹è±¡åˆ°å­ä»»åŠ¡IDæ˜ å°„ï¼Œä¾›ä¸Šä¼ ä½¿ç”¨
              this.saveFileForTask(subTask.file_id, file);
              
              await this.uploadSingleFile(fileItem);
              completedFiles++;
              folderItem.completedFiles = completedFiles;
              
              // æ›´æ–°æ–‡ä»¶å¤¹ä»»åŠ¡è¿›åº¦
              folderItem.progress = Math.round((completedFiles / taskDetail.sub_tasks.length) * 100);
              folderItem.completion_rate = folderItem.progress;
              
              this.log('ğŸ“„ æ–‡ä»¶å¤¹ä¸­å®Œæˆ: ' + subTask.relative_path + ' (' + completedFiles + '/' + taskDetail.sub_tasks.length + ')', 'success');
            } catch (error) {
              failedFiles++;
              this.log('ğŸ“„ æ–‡ä»¶å¤¹ä¸­å¤±è´¥: ' + subTask.relative_path + ' - ' + error.message, 'error');
            }
          }
          
          // è°ƒæ•´å¤±è´¥ç»Ÿè®¡ï¼šåªç»Ÿè®¡çœŸæ­£çš„ä¸Šä¼ å¤±è´¥ï¼Œä¸åŒ…æ‹¬ç¼ºå°‘æ–‡ä»¶å¯¹è±¡çš„æƒ…å†µ
          const actualFailedFiles = failedFiles - unmappedFiles;
          
          if (actualFailedFiles > 0) {
            throw new Error('æ–‡ä»¶å¤¹ä¸Šä¼ å®Œæˆï¼Œä½†æœ‰ ' + actualFailedFiles + ' ä¸ªæ–‡ä»¶ä¸Šä¼ å¤±è´¥');
          } else if (unmappedFiles > 0) {
            this.log('æ–‡ä»¶å¤¹ä¸Šä¼ å®Œæˆï¼Œä½†æœ‰ ' + unmappedFiles + ' ä¸ªæ–‡ä»¶å› ç¼ºå°‘æ–‡ä»¶å¯¹è±¡è€Œè·³è¿‡', 'warning');
          }
          
          this.log('ğŸ“ æ–‡ä»¶å¤¹ä¸Šä¼ å®Œæˆ: ' + taskDetail.folder_name, 'success');
        },
        
        // å•æ–‡ä»¶ä¸Šä¼ 
        async uploadSingleFile(fileItem) {
          const taskId = fileItem.task_id || fileItem.file_id;
          
          // å°è¯•è·å–ä¿å­˜çš„æ–‡ä»¶å¯¹è±¡
          let file = this.getFileForTask(taskId);
          
          if (!file && fileItem.isRecovered) {
            // æ¢å¤çš„ä»»åŠ¡ï¼Œæ— æ³•ç»§ç»­ä¸Šä¼ ï¼ˆå› ä¸ºæ²¡æœ‰åŸå§‹æ–‡ä»¶å¯¹è±¡ï¼‰
            this.log('âš ï¸ æ¢å¤çš„ä»»åŠ¡æ— æ³•ç»§ç»­ä¸Šä¼ ï¼Œè¯·é‡æ–°é€‰æ‹©æ–‡ä»¶: ' + fileItem.filename, 'warning');
            this.showNotification('æ¢å¤çš„ä»»åŠ¡ "' + fileItem.filename + '" æ— æ³•ç»§ç»­ä¸Šä¼ ï¼Œè¯·é‡æ–°é€‰æ‹©æ–‡ä»¶', 'warning');
            throw new Error('æ¢å¤çš„ä»»åŠ¡æ— æ³•ç»§ç»­ä¸Šä¼ ï¼Œç¼ºå°‘åŸå§‹æ–‡ä»¶å¯¹è±¡');
          }
          
          if (!file) {
            this.log('âš ï¸ æœªæ‰¾åˆ°æ–‡ä»¶å¯¹è±¡ï¼Œä»»åŠ¡å¯èƒ½æ˜¯ä»æœåŠ¡å™¨æ¢å¤çš„: ' + fileItem.filename, 'warning');
            this.showNotification('ä»»åŠ¡ "' + fileItem.filename + '" ç¼ºå°‘æ–‡ä»¶å¯¹è±¡ï¼Œè¯·é‡æ–°é€‰æ‹©æ–‡ä»¶', 'warning');
            throw new Error('ç¼ºå°‘åŸå§‹æ–‡ä»¶å¯¹è±¡');
          }
          
          const fileId = taskId;
          const chunkSize = this.config.chunkSize * 1024 * 1024;
          const totalChunks = Math.ceil(file.size / chunkSize);
          
          // æ£€æŸ¥æœåŠ¡å™¨ä¸Šçš„ä¸Šä¼ çŠ¶æ€
          let uploadedChunks = [];
          try {
            const response = await this.fetchWithRetry('/go-uploader/upload_status?file_id=' + encodeURIComponent(fileId));
            const data = await response.json();
            uploadedChunks = data.uploaded_chunks || [];
            
            if (uploadedChunks.length > 0) {
              this.log('ğŸ“„ æ£€æµ‹åˆ° ' + uploadedChunks.length + '/' + totalChunks + ' ä¸ªåˆ†ç‰‡å·²ä¸Šä¼ ï¼Œç»§ç»­æ–­ç‚¹ç»­ä¼ ', 'info');
              
              // ä¿å­˜è·¯å¾„è®°å¿†
              this.saveRecoveryPath(fileId, file.name, file.size);
            }
          } catch (error) {
            this.log('è·å–ä¸Šä¼ çŠ¶æ€å¤±è´¥: ' + error.message, 'warning');
          }

          // ä¸Šä¼ åˆ†ç‰‡
          for (let i = 0; i < totalChunks; i++) {
            if (fileItem.cancelFlag || fileItem.isPaused) {
              throw new Error('ä¸Šä¼ è¢«ä¸­æ–­');
            }
            
            if (uploadedChunks.includes(i)) {
              continue; // è·³è¿‡å·²ä¸Šä¼ çš„åˆ†ç‰‡
            }

            const start = i * chunkSize;
            const end = Math.min(file.size, start + chunkSize);
            const chunk = file.slice(start, end);

            await this.uploadChunk(fileId, i, chunk, file, fileItem);
            
            // ä¸Šä¼ æˆåŠŸåç»Ÿè®¡å­—èŠ‚æ•°ï¼ˆç”¨äºé€Ÿåº¦è®¡ç®—ï¼‰
            this.lastUploadedBytes += chunk.size;
            
            // è°ƒè¯•ï¼šè®°å½•å­—èŠ‚ç´¯åŠ 
            if (i % 10 === 0 || i === totalChunks - 1) { // æ¯10ä¸ªåˆ†ç‰‡æˆ–æœ€åä¸€ä¸ªåˆ†ç‰‡è®°å½•ä¸€æ¬¡
              this.log('å­—èŠ‚ç´¯åŠ : åˆ†ç‰‡' + i + '/' + (totalChunks - 1) + ', å¤§å°=' + this.formatFileSize(chunk.size) + ', ç´¯è®¡=' + this.formatFileSize(this.lastUploadedBytes), 'info');
            }
            
            // æ›´æ–°è¿›åº¦
            fileItem.progress = Math.round(((i + 1) / totalChunks) * 100);
            fileItem.completion_rate = fileItem.progress;
            fileItem.uploadedBytes = (i + 1) * chunkSize;
          }
          
          // åˆå¹¶æ–‡ä»¶
          await this.mergeFile(fileId, file, totalChunks);
        },
        
        // ä¸Šä¼ åˆ†ç‰‡
        async uploadChunk(fileId, chunkIndex, chunk, file, fileItem) {
          const formData = new FormData();
          formData.append('file_id', fileId);
          formData.append('chunk_index', chunkIndex);
          formData.append('chunk', chunk);
          formData.append('relative_path', file.webkitRelativePath || file.name);
          formData.append('total_chunks', Math.ceil(file.size / (this.config.chunkSize * 1024 * 1024)));
          formData.append('file_size', file.size);
          
          if (this.config.enableMD5 === 'true') {
            const md5 = await this.calculateMD5(chunk);
            formData.append('md5', md5);
          }
          
          const response = await this.fetchWithRetry('/go-uploader/upload_chunk', {
            method: 'POST',
            body: formData
          });
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || 'ä¸Šä¼ åˆ†ç‰‡ ' + chunkIndex + ' å¤±è´¥: ' + response.status);
          }
        },

        // åˆå¹¶æ–‡ä»¶
        async mergeFile(fileId, file, totalChunks) {
          const formData = new FormData();
          formData.append('file_id', fileId);
          formData.append('filename', file.name);
          formData.append('total_chunks', totalChunks);
          formData.append('relative_path', file.webkitRelativePath || file.name);
          
          const response = await this.fetchWithRetry('/go-uploader/merge_chunks', {
            method: 'POST',
            body: formData
          });
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || 'åˆå¹¶æ–‡ä»¶å¤±è´¥: ' + response.status);
          }
          
          const result = await response.json();
          this.log('æ–‡ä»¶åˆå¹¶æˆåŠŸ: ' + result.filePath, 'success');
          
          // ä¿å­˜è·¯å¾„è®°å¿†
          this.saveRecoveryPath(fileId, file.webkitRelativePath || file.name, file.size);
          
          return result;
        },
        

        
        // MD5è®¡ç®— - ä¿®å¤ç‰ˆæœ¬
        async calculateMD5(file) {
          return new Promise((resolve, reject) => {
            const spark = new SparkMD5.ArrayBuffer();
            const fileReader = new FileReader();
            
            fileReader.onload = function(e) {
              spark.append(e.target.result);
              resolve(spark.end());
            };
            
            fileReader.onerror = function() {
              reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
            };
            
            fileReader.readAsArrayBuffer(file);
          });
        },
        
        // ç½‘ç»œè¯·æ±‚é‡è¯•
        async fetchWithRetry(url, options = {}, attempts = undefined) {
          const maxAttempts = attempts || this.config.retryCount;
          
          // æ·»åŠ è®¤è¯å¤´
          const authHeaders = this.getAuthHeaders();
          
          // å¦‚æœè¯·æ±‚ä½“æ˜¯FormDataï¼Œä¸è¦è®¾ç½®Content-Typeï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®
          if (options.body instanceof FormData) {
            // åªæ·»åŠ è®¤è¯ç›¸å…³çš„å¤´ï¼Œä¸åŒ…æ‹¬Content-Type
            const { 'Content-Type': _, ...authHeadersWithoutContentType } = authHeaders;
            if (options.headers) {
              options.headers = { ...authHeadersWithoutContentType, ...options.headers };
            } else {
              options.headers = authHeadersWithoutContentType;
            }
          } else {
            // éFormDataè¯·æ±‚ï¼Œæ­£å¸¸æ·»åŠ æ‰€æœ‰å¤´
            if (options.headers) {
              options.headers = { ...authHeaders, ...options.headers };
            } else {
              options.headers = authHeaders;
            }
          }
          
          for (let i = 0; i < maxAttempts; i++) {
            try {
              const response = await fetch(url, options);
              if (response.ok) {
                return response;
              }
              throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            } catch (error) {
              if (i === maxAttempts - 1) {
                throw error;
              }
              
              const delay = Math.min(1000 * Math.pow(2, i), 10000);
              this.log('è¯·æ±‚å¤±è´¥ï¼Œ' + delay + 'ms åé‡è¯• (' + (i + 1) + '/' + maxAttempts + '): ' + error.message, 'warning');
              await this.sleep(delay);
            }
          }
        },
        
        async deleteTask(fileId) {
          if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) return;
          
          try {
            const response = await fetch('/go-uploader/tasks/' + fileId, { 
              method: 'DELETE',
              headers: this.getAuthHeaders()
            });
            if (response.ok) {
              this.showNotification('ä»»åŠ¡å·²åˆ é™¤', 'success');
              this.refreshServerTasks();
            } else {
              const error = await response.json();
              this.showNotification(error.error || 'åˆ é™¤ä»»åŠ¡å¤±è´¥', 'error');
            }
          } catch (error) {
            this.showNotification('åˆ é™¤ä»»åŠ¡å¤±è´¥', 'error');
          }
        },
        
        async cleanupTasks() {
          if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰å·²å®Œæˆå’Œå¤±è´¥çš„ä»»åŠ¡å—ï¼Ÿ')) return;
          
          try {
            const response = await fetch('/go-uploader/tasks/cleanup', { 
              method: 'POST',
              headers: this.getAuthHeaders()
            });
            if (response.ok) {
              const result = await response.json();
              this.showNotification(result.message, 'success');
              this.refreshServerTasks();
            } else {
              const error = await response.json();
              this.showNotification(error.error || 'æ¸…ç†ä»»åŠ¡å¤±è´¥', 'error');
            }
          } catch (error) {
            this.showNotification('æ¸…ç†ä»»åŠ¡å¤±è´¥', 'error');
          }
        },
        
        // æ‰¹é‡æ¢å¤æ‰€æœ‰å¤±è´¥ä»»åŠ¡
        async resumeAllFailedTasks() {
          if (!confirm('ç¡®å®šè¦æ¢å¤æ‰€æœ‰å¤±è´¥çš„ä»»åŠ¡å—ï¼Ÿ')) return;
          
          try {
            const response = await fetch('/go-uploader/tasks/resume_all_failed', { 
              method: 'POST',
              headers: this.getAuthHeaders()
            });
            if (response.ok) {
              const result = await response.json();
              this.showNotification(result.message, 'success');
              this.refreshServerTasks();
            } else {
              const error = await response.json();
              this.showNotification(error.error || 'æ‰¹é‡æ¢å¤å¤±è´¥', 'error');
            }
          } catch (error) {
            this.showNotification('æ‰¹é‡æ¢å¤å¤±è´¥', 'error');
          }
        },
        
        // æ˜¾ç¤ºå¤±è´¥ä»»åŠ¡åˆ—è¡¨
        async showFailedTasks() {
          try {
            const response = await fetch('/go-uploader/tasks/failed', {
              headers: this.getAuthHeaders()
            });
            
            if (response.ok) {
              const result = await response.json();
              const failedTasks = result.failed_tasks || [];
              
              if (failedTasks.length === 0) {
                this.showNotification('å½“å‰æ²¡æœ‰å¤±è´¥çš„ä»»åŠ¡', 'info');
                return;
              }
              
              // æ„å»ºå¤±è´¥ä»»åŠ¡è¯¦æƒ…
              let taskList = failedTasks.map(task => {
                return `â€¢ ${task.filename || task.folder_name || task.file_id} (${task.status})`;
              }).join('\n');
              
              const message = `æ‰¾åˆ° ${failedTasks.length} ä¸ªå¤±è´¥çš„ä»»åŠ¡ï¼š\n\n${taskList}\n\næ˜¯å¦è¦æ‰¹é‡æ¢å¤è¿™äº›ä»»åŠ¡ï¼Ÿ`;
              
              if (confirm(message)) {
                this.resumeAllFailedTasks();
              }
            } else {
              const error = await response.json();
              this.showNotification(error.error || 'è·å–å¤±è´¥ä»»åŠ¡åˆ—è¡¨å¤±è´¥', 'error');
            }
          } catch (error) {
            this.showNotification('è·å–å¤±è´¥ä»»åŠ¡åˆ—è¡¨å¤±è´¥', 'error');
          }
        },
        
        // ç³»ç»Ÿç›‘æ§
        async checkSystemHealth() {
          try {
            const response = await fetch('/go-uploader/health', {
              headers: this.getAuthHeaders()
            });
            const health = await response.json();
            this.systemHealth = health.status;
          } catch (error) {
            this.systemHealth = 'unhealthy';
          }
        },
        
        async updateSystemStatus() {
          try {
            const [metricsResponse, systemResponse] = await Promise.all([
              fetch('/go-uploader/metrics', {
                headers: this.getAuthHeaders()
              }),
              fetch('/go-uploader/system', {
                headers: this.getAuthHeaders()
              })
            ]);
            
            if (metricsResponse.ok) {
              const metrics = await metricsResponse.json();
              this.metrics = {
                activeTasks: metrics.metrics.active_tasks || 0,
                memoryUsage: metrics.metrics.memory_mb || 0,
                goroutines: metrics.metrics.goroutines || 0
              };
            }
            
            if (systemResponse.ok) {
              const systemData = await systemResponse.json();
              if (systemData.disk_usage && systemData.disk_usage.usage_percent) {
                this.systemInfo.diskUsage = systemData.disk_usage.usage_percent.toFixed(1);
              }
            }
          } catch (error) {
            // é™é»˜å¤„ç†ç›‘æ§æ•°æ®è·å–å¤±è´¥
          }
        },
        
        updateUploadSpeed() {
          const now = Date.now();
          const timeDiff = (now - this.lastSpeedUpdate) / 1000;
          
          // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨ä¸Šä¼ çš„ä»»åŠ¡
          const uploadingTasks = (this.serverTasks || []).filter(t => t.isUploading);
          
          // è°ƒè¯•ä¿¡æ¯ï¼šè®°å½•é€Ÿåº¦è®¡ç®—çš„å…³é”®æ•°æ®
          if (this.debugSpeedCounter === undefined) this.debugSpeedCounter = 0;
          this.debugSpeedCounter++;
          
          if (this.debugSpeedCounter % 10 === 0) { // æ¯10ç§’è®°å½•ä¸€æ¬¡è°ƒè¯•ä¿¡æ¯
            this.log('é€Ÿåº¦è°ƒè¯•: æ­£åœ¨ä¸Šä¼ ä»»åŠ¡æ•°=' + uploadingTasks.length + 
                    ', ç´¯è®¡å­—èŠ‚=' + this.lastUploadedBytes + 
                    ', å½“å‰é€Ÿåº¦=' + this.formatSpeed(this.uploadSpeed), 'info');
          }
          
          if (uploadingTasks.length === 0) {
            // æ²¡æœ‰ä»»åŠ¡åœ¨ä¸Šä¼ æ—¶ï¼Œé€Ÿåº¦é€æ¸è¡°å‡åˆ°0
            this.uploadSpeed = this.uploadSpeed > 0 ? this.uploadSpeed * 0.8 : 0;
            if (this.uploadSpeed < 0.01) {
              this.uploadSpeed = 0;
            }
            return;
          }
          
          // è®¡ç®—ä¸Šä¼ é€Ÿåº¦ï¼ˆè‡³å°‘ç­‰å¾…1ç§’å†æ›´æ–°ï¼‰
          if (timeDiff >= 1) {
            const bytesDiff = this.lastUploadedBytes;
            this.uploadSpeed = bytesDiff / timeDiff;
            this.lastUploadedBytes = 0;
            this.lastSpeedUpdate = now;
            
            // è®°å½•é€Ÿåº¦è®¡ç®—ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
            if (bytesDiff > 0) {
              this.log('é€Ÿåº¦æ›´æ–°: ' + this.formatSpeed(this.uploadSpeed) + ' (æœ¬æ¬¡ä¸Šä¼  ' + this.formatFileSize(bytesDiff) + ', ç”¨æ—¶ ' + timeDiff.toFixed(1) + 's)', 'info');
              this.previousSpeed = this.uploadSpeed;
            }
          }
        },
        
        // è¯¦æƒ…å’Œæ¨¡æ€æ¡†
        async showTaskDetail(task) {
          try {
            const taskId = task.task_id || task.file_id;
            const response = await fetch('/go-uploader/tasks/' + taskId, {
              headers: this.getAuthHeaders()
            });
            const taskDetail = await response.json();
            
            if (taskDetail.task_type === 'folder') {
              // æ–‡ä»¶å¤¹ä»»åŠ¡è¯¦æƒ…
              this.modalTitle = 'ğŸ“ æ–‡ä»¶å¤¹ä»»åŠ¡è¯¦æƒ…';
              this.modalContent = 
                '<div class="space-y-4">' +
                  '<div class="grid grid-cols-2 gap-4">' +
                    '<div class="bg-purple-50 p-3 rounded-lg border border-purple-200">' +
                      '<div class="text-lg font-bold text-gray-800">' + taskDetail.folder_name + '</div>' +
                      '<div class="text-sm text-gray-600">æ–‡ä»¶å¤¹åç§°</div>' +
                    '</div>' +
                    '<div class="bg-gray-50 p-3 rounded-lg border border-gray-200">' +
                      '<div class="text-lg font-bold text-gray-800">' + taskDetail.total_files + '</div>' +
                      '<div class="text-sm text-gray-600">æ€»æ–‡ä»¶æ•°</div>' +
                    '</div>' +
                    '<div class="bg-green-50 p-3 rounded-lg border border-green-200">' +
                      '<div class="text-lg font-bold text-gray-800">' + (taskDetail.completed_files || 0) + '</div>' +
                      '<div class="text-sm text-gray-600">å·²å®Œæˆ</div>' +
                    '</div>' +
                    '<div class="bg-red-50 p-3 rounded-lg border border-red-200">' +
                      '<div class="text-lg font-bold text-gray-800">' + (taskDetail.failed_files || 0) + '</div>' +
                      '<div class="text-sm text-gray-600">å¤±è´¥æ–‡ä»¶</div>' +
                    '</div>' +
                    '<div class="bg-blue-50 p-3 rounded-lg border border-blue-200">' +
                      '<div class="text-lg font-bold text-gray-800">' + this.formatFileSize(taskDetail.file_size) + '</div>' +
                      '<div class="text-sm text-gray-600">æ€»å¤§å°</div>' +
                    '</div>' +
                    '<div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">' +
                      '<div class="text-lg font-bold text-gray-800">' + (taskDetail.completion_rate || 0).toFixed(1) + '%</div>' +
                      '<div class="text-sm text-gray-600">å®Œæˆç‡</div>' +
                    '</div>' +
                  '</div>' +
                  '<div class="space-y-2 text-sm text-gray-700">' +
                    '<p><strong>ä»»åŠ¡ID:</strong> ' + taskDetail.task_id + '</p>' +
                    '<p><strong>çŠ¶æ€:</strong> ' + this.getStatusText(taskDetail.status) + '</p>' +
                    '<p><strong>å·²ä¸Šä¼ å¤§å°:</strong> ' + this.formatFileSize(taskDetail.uploaded_size || 0) + '</p>' +
                    '<p><strong>åˆ›å»ºæ—¶é—´:</strong> ' + new Date(taskDetail.created_at).toLocaleString() + '</p>' +
                    '<p><strong>æ›´æ–°æ—¶é—´:</strong> ' + new Date(taskDetail.updated_at).toLocaleString() + '</p>' +
                    '<p><strong>é‡è¯•æ¬¡æ•°:</strong> ' + (taskDetail.retry_count || 0) + '</p>' +
                  '</div>' +
                  '<div class="mt-4">' +
                    '<h4 class="font-semibold text-gray-800 mb-2">å­æ–‡ä»¶åˆ—è¡¨:</h4>' +
                    '<div class="bg-gray-100 rounded p-3 max-h-48 overflow-y-auto text-xs space-y-1">' +
                      (taskDetail.sub_tasks && taskDetail.sub_tasks.length > 0 ? 
                        taskDetail.sub_tasks.map(subTask => {
                          const statusColor = subTask.status === 'completed' ? 'text-green-600' : 
                                             subTask.status === 'failed' ? 'text-red-600' : 'text-yellow-600';
                          return 
                            '<div class="flex justify-between items-center p-2 bg-white rounded border">' +
                              '<span class="truncate flex-1">' + subTask.relative_path + '</span>' +
                              '<span class="' + statusColor + ' font-medium ml-2">' + this.getStatusText(subTask.status) + '</span>' +
                            '</div>';
                        }).join('') : 
                        '<div class="text-gray-500 text-center py-4">æš‚æ— å­æ–‡ä»¶ä¿¡æ¯</div>'
                      ) +
                    '</div>' +
                  '</div>' +
                '</div>';
            } else {
              // å•æ–‡ä»¶ä»»åŠ¡è¯¦æƒ…
              this.modalTitle = 'ğŸ“„ æ–‡ä»¶ä»»åŠ¡è¯¦æƒ…';
              this.modalContent = 
                '<div class="space-y-4">' +
                  '<div class="grid grid-cols-2 gap-4">' +
                    '<div class="bg-blue-50 p-3 rounded-lg border border-blue-200">' +
                      '<div class="text-lg font-bold text-gray-800">' + taskDetail.filename + '</div>' +
                      '<div class="text-sm text-gray-600">æ–‡ä»¶å</div>' +
                    '</div>' +
                    '<div class="bg-gray-50 p-3 rounded-lg border border-gray-200">' +
                      '<div class="text-lg font-bold text-gray-800">' + this.formatFileSize(taskDetail.file_size) + '</div>' +
                      '<div class="text-sm text-gray-600">æ–‡ä»¶å¤§å°</div>' +
                    '</div>' +
                    '<div class="bg-green-50 p-3 rounded-lg border border-green-200">' +
                      '<div class="text-lg font-bold text-gray-800">' + (taskDetail.completion_rate || 0).toFixed(1) + '%</div>' +
                      '<div class="text-sm text-gray-600">å®Œæˆåº¦</div>' +
                    '</div>' +
                    '<div class="bg-purple-50 p-3 rounded-lg border border-purple-200">' +
                      '<div class="text-lg font-bold text-gray-800">' + this.getStatusText(taskDetail.status) + '</div>' +
                      '<div class="text-sm text-gray-600">çŠ¶æ€</div>' +
                    '</div>' +
                  '</div>' +
                  '<div class="space-y-2 text-sm text-gray-700">' +
                    '<p><strong>ä»»åŠ¡ID:</strong> ' + taskDetail.task_id + '</p>' +
                    '<p><strong>ç›¸å¯¹è·¯å¾„:</strong> ' + (taskDetail.relative_path || '/') + '</p>' +
                    '<p><strong>æ€»åˆ†ç‰‡æ•°:</strong> ' + taskDetail.total_chunks + '</p>' +
                    '<p><strong>å·²ä¸Šä¼ åˆ†ç‰‡:</strong> ' + (taskDetail.uploaded_chunks ? taskDetail.uploaded_chunks.length : 0) + '/' + taskDetail.total_chunks + '</p>' +
                    '<p><strong>åˆ›å»ºæ—¶é—´:</strong> ' + new Date(taskDetail.created_at).toLocaleString() + '</p>' +
                    '<p><strong>æ›´æ–°æ—¶é—´:</strong> ' + new Date(taskDetail.updated_at).toLocaleString() + '</p>' +
                    '<p><strong>é‡è¯•æ¬¡æ•°:</strong> ' + (taskDetail.retry_count || 0) + '</p>' +
                    (taskDetail.file_md5 ? '<p><strong>æ–‡ä»¶MD5:</strong> ' + taskDetail.file_md5 + '</p>' : '') +
                    (taskDetail.parent_task_id ? '<p><strong>çˆ¶ä»»åŠ¡ID:</strong> ' + taskDetail.parent_task_id + '</p>' : '') +
                  '</div>' +
                  '<div class="mt-4">' +
                    '<h4 class="font-semibold text-gray-800 mb-2">åˆ†ç‰‡è¯¦æƒ…:</h4>' +
                    '<div class="bg-gray-100 rounded p-3 max-h-32 overflow-y-auto text-xs">' +
                      'å·²ä¸Šä¼ åˆ†ç‰‡: ' + (taskDetail.uploaded_chunks ? taskDetail.uploaded_chunks.join(', ') : 'æ— ') +
                    '</div>' +
                  '</div>' +
                '</div>';
            }
            
            this.showModal = true;
          } catch (error) {
            this.showNotification('è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥', 'error');
          }
        },
        
        async showSystemInfo() {
          try {
            const response = await fetch('/go-uploader/system');
            const data = await response.json();
            
            this.modalTitle = 'ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯';
            this.modalContent = 
              '<div class="space-y-6">' +
                '<div>' +
                  '<h4 class="text-lg font-semibold mb-3 text-gray-800">ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯</h4>' +
                  '<div class="space-y-2 text-sm text-gray-700">' +
                    '<p><strong>Goç‰ˆæœ¬:</strong> ' + data.system.go_version + '</p>' +
                    '<p><strong>åç¨‹æ•°:</strong> ' + data.system.goroutines + '</p>' +
                    '<p><strong>å†…å­˜åˆ†é…:</strong> ' + data.system.memory_alloc + ' MB</p>' +
                    '<p><strong>ç³»ç»Ÿå†…å­˜:</strong> ' + data.system.memory_sys + ' MB</p>' +
                    '<p><strong>GCè¿è¡Œæ¬¡æ•°:</strong> ' + data.system.gc_runs + '</p>' +
                  '</div>' +
                '</div>' +
                
                '<div>' +
                  '<h4 class="text-lg font-semibold mb-3 text-gray-800">âš™ï¸ é…ç½®ä¿¡æ¯</h4>' +
                  '<div class="space-y-2 text-sm text-gray-700">' +
                    '<p><strong>ä¸Šä¼ ç›®å½•:</strong> ' + data.config.upload_dir + '</p>' +
                    '<p><strong>åˆå¹¶ç›®å½•:</strong> ' + data.config.merged_dir + '</p>' +
                    '<p><strong>æœ€å¤§æ–‡ä»¶å¤§å°:</strong> ' + this.formatFileSize(data.config.max_file_size) + '</p>' +
                    '<p><strong>æœ€å¤§åˆ†ç‰‡å¤§å°:</strong> ' + this.formatFileSize(data.config.max_chunk_size) + '</p>' +
                    '<p><strong>å¹¶å‘ä¸Šä¼ æ•°:</strong> ' + data.config.concurrent_uploads + '</p>' +
                    '<p><strong>å®Œæ•´æ€§æ£€æŸ¥:</strong> ' + (data.config.enable_integrity_check ? 'å¯ç”¨' : 'ç¦ç”¨') + '</p>' +
                    '<p><strong>åŸå­æ“ä½œ:</strong> ' + (data.config.enable_atomic_operations ? 'å¯ç”¨' : 'ç¦ç”¨') + '</p>' +
                  '</div>' +
                '</div>' +
                
                '<div>' +
                  '<h4 class="text-lg font-semibold mb-3 text-gray-800">ğŸ“Š ç£ç›˜ä½¿ç”¨</h4>' +
                  '<div class="space-y-2 text-sm text-gray-700">' +
                    '<p><strong>ä¸Šä¼ ç›®å½•å¤§å°:</strong> ' + this.formatFileSize(data.disk_usage.upload_dir_size || 0) + '</p>' +
                    '<p><strong>åˆå¹¶ç›®å½•å¤§å°:</strong> ' + this.formatFileSize(data.disk_usage.merged_dir_size || 0) + '</p>' +
                    '<p><strong>æ€»ä½¿ç”¨é‡:</strong> ' + this.formatFileSize(data.disk_usage.total_used || 0) + '</p>' +
                    '<p><strong>ä½¿ç”¨ç‡:</strong> ' + (data.disk_usage.usage_percent || 0).toFixed(2) + '%</p>' +
                  '</div>' +
                '</div>' +
              '</div>';
            this.showModal = true;
          } catch (error) {
            this.showNotification('è·å–ç³»ç»Ÿä¿¡æ¯å¤±è´¥', 'error');
          }
        },
        
        closeModal() {
          this.showModal = false;
        },
        
        // æ›´æ–°å’Œè®¡ç®—
        updateChunkSize() {
          this.log('åˆ†ç‰‡å¤§å°è°ƒæ•´ä¸º: ' + this.config.chunkSize + 'MB', 'info');
        },
        
        // UIè¾…åŠ©æ–¹æ³•
        showNotification(message, type = 'info') {
          const id = Date.now() + Math.random();
          const notification = { id, message, type, show: false };
          
          this.notifications.push(notification);
          
          setTimeout(() => {
            notification.show = true;
          }, 100);
          
          setTimeout(() => {
            notification.show = false;
            setTimeout(() => {
              this.notifications = this.notifications.filter(n => n.id !== id);
            }, 300);
          }, 4000);
        },
        
        log(message, level = 'info') {
          const timestamp = new Date().toLocaleTimeString();
          this.logs.push({
            id: Date.now() + Math.random(),
            timestamp: '[' + timestamp + ']',
            message: message,
            level: level
          });
          
          // é™åˆ¶æ—¥å¿—æ•°é‡
          if (this.logs.length > 100) {
            this.logs = this.logs.slice(-100);
          }
        },
        
        // æ ·å¼ç±»è¾…åŠ©æ–¹æ³•
        getStatusClass(status) {
          const classes = {
            'pending': 'bg-yellow-100 text-yellow-800',
            'uploading': 'bg-blue-100 text-blue-800',
            'completed': 'bg-green-100 text-green-800',
            'error': 'bg-red-100 text-red-800',
            'failed': 'bg-red-100 text-red-800',
            'partial_failed': 'bg-orange-100 text-orange-800',
            'paused': 'bg-gray-100 text-gray-800',
            'waiting_files': 'bg-orange-100 text-orange-800'
          };
          return classes[status] || 'bg-gray-100 text-gray-800';
        },
        
        getStatusText(status) {
          const texts = {
            'pending': 'ç­‰å¾…',
            'uploading': 'ä¸Šä¼ ä¸­',
            'completed': 'å®Œæˆ',
            'error': 'å¤±è´¥',
            'failed': 'å¤±è´¥',
            'partial_failed': 'éƒ¨åˆ†å¤±è´¥',
            'paused': 'æš‚åœ',
            'waiting_files': 'ç­‰å¾…æ–‡ä»¶'
          };
          return texts[status] || 'æœªçŸ¥';
        },
        
        getLogClass(level) {
          const classes = {
            'info': 'text-blue-600',
            'success': 'text-green-600',
            'warning': 'text-yellow-600',
            'error': 'text-red-600'
          };
          return classes[level] || 'text-gray-800';
        },
        
        getNotificationClass(type) {
          const classes = {
            'success': 'bg-green-500 text-white',
            'error': 'bg-red-500 text-white',
            'warning': 'bg-yellow-500 text-black',
            'info': 'bg-blue-500 text-white'
          };
          return classes[type] || 'bg-blue-500 text-white';
        },
        
        getNotificationIcon(type) {
          const icons = {
            'success': 'âœ…',
            'error': 'âŒ',
            'warning': 'âš ï¸',
            'info': 'â„¹ï¸'
          };
          return icons[type] || 'â„¹ï¸';
        },
        
        // è®¡ç®—å±æ€§
        get systemHealthText() {
          const texts = {
            'healthy': 'æ­£å¸¸',
            'warning': 'è­¦å‘Š',
            'unhealthy': 'å¼‚å¸¸',
            'checking': 'æ£€æŸ¥ä¸­'
          };
          return texts[this.systemHealth] || 'æœªçŸ¥';
        },
        
        // å·¥å…·æ–¹æ³•
        formatFileSize(bytes) {
          if (bytes === 0) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        
        formatSpeed(bytesPerSecond) {
          if (bytesPerSecond === 0) return '0 MB/s';
          const mbps = bytesPerSecond / (1024 * 1024);
          return mbps.toFixed(2) + ' MB/s';
        },
        
        formatTime(seconds) {
          if (!seconds || seconds === Infinity || isNaN(seconds)) return '--:--:--';
          const hours = Math.floor(seconds / 3600);
          const minutes = Math.floor((seconds % 3600) / 60);
          const secs = Math.floor(seconds % 60);
          return hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
        },
        
        sleep(ms) {
          return new Promise(resolve => setTimeout(resolve, ms));
        },
        
        // æš‚åœä»»åŠ¡
        pauseTask(task) {
          task.isPaused = true;
          task.isUploading = false;
          this.log('â¸ï¸ å·²æš‚åœä»»åŠ¡: ' + (task.folder_name || task.filename), 'info');
          this.showNotification('å·²æš‚åœä»»åŠ¡: ' + (task.folder_name || task.filename), 'info');
        },
        // æ¢å¤ä»»åŠ¡
        async resumeTask(task) {
          // å¦‚æœæ˜¯æœ¬åœ°æš‚åœçŠ¶æ€ï¼Œç›´æ¥æ¢å¤
          if (task.isPaused) {
            task.isPaused = false;
            this.startUpload(task);
            return;
          }
          
          // å¦‚æœæ˜¯æœåŠ¡å™¨ç«¯çš„å¤±è´¥çŠ¶æ€ï¼Œè°ƒç”¨æœåŠ¡å™¨æ¢å¤æ¥å£
          if (task.status === 'failed' || task.status === 'partial_failed') {
            try {
              const taskId = task.task_id || task.file_id;
              const response = await fetch(`/go-uploader/tasks/${taskId}/resume`, {
                method: 'POST',
                headers: this.getAuthHeaders()
              });
              
              if (response.ok) {
                const result = await response.json();
                this.showNotification(result.message || 'ä»»åŠ¡å·²æ¢å¤', 'success');
                this.refreshServerTasks(); // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
              } else {
                const error = await response.json();
                this.showNotification(error.error || 'æ¢å¤ä»»åŠ¡å¤±è´¥', 'error');
              }
            } catch (error) {
              this.showNotification('æ¢å¤ä»»åŠ¡å¤±è´¥', 'error');
            }
          }
        },
        // å–æ¶ˆä»»åŠ¡
        cancelTask(task) {
          task.cancelFlag = true;
          task.isUploading = false;
          this.log('âŒ å·²å–æ¶ˆä»»åŠ¡: ' + (task.folder_name || task.filename), 'info');
          this.showNotification('å·²å–æ¶ˆä»»åŠ¡: ' + (task.folder_name || task.filename), 'info');
        },
      };
    }
  </script>
</body>
</html>
